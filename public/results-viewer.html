<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOINC æ˜ å°„çµæœæŸ¥çœ‹å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', 'PingFang TC', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .file-selector {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .file-selector h2 {
            color: #1a73e8;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .file-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .file-list::-webkit-scrollbar {
            width: 8px;
        }

        .file-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .file-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .file-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .pagination-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #1557b0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }

        .pagination-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .file-item {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .file-item:hover {
            border-color: #1a73e8;
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 115, 232, 0.2);
        }

        .file-item.selected {
            border-color: #1a73e8;
            background: #e3f2fd;
        }

        .file-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .file-name {
            font-weight: bold;
            color: #1a73e8;
            flex-grow: 1;
        }

        .delete-btn-card {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 50%;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .delete-btn-card:hover {
            opacity: 1;
            background: #d32f2f;
            transform: scale(1.1);
        }

        .file-info {
            font-size: 0.9rem;
            color: #666;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .main-content.show {
            display: block;
        }

        .content-header {
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .content-header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .content-header .timestamp {
            opacity: 0.9;
            font-size: 1rem;
        }

        .content-body {
            padding: 0;
        }

        .section {
            border-bottom: 1px solid #e0e0e0;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-header {
            background: #f8f9fa;
            padding: 20px 30px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
        }

        .section-header:hover {
            background: #e9ecef;
        }

        .section-header.active {
            background: #e3f2fd;
            border-left-color: #1a73e8;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1a73e8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.5rem;
        }

        .expand-icon {
            font-size: 1.5rem;
            color: #666;
            transition: transform 0.3s ease;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 0 30px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-content.expanded {
            max-height: none;
            padding: 30px;
        }

        .input-variables {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .variables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .variable-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .variable-label {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .variable-value {
            color: #333;
            font-size: 1.1rem;
            word-break: break-word;
        }

        .search-info {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .search-terms {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .search-term {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .search-term-label {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 8px;
        }

        .search-term-value {
            color: #333;
            font-size: 1.1rem;
        }

        .loinc-results {
            margin-bottom: 20px;
        }

        .loinc-card {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #ff9800;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
        }

        .loinc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .loinc-code {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e65100;
        }

        .similarity-score {
            background: #e65100;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .loinc-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .loinc-detail {
            background: white;
            padding: 12px;
            border-radius: 6px;
        }

        .loinc-detail-label {
            font-weight: bold;
            color: #e65100;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .loinc-detail-value {
            color: #333;
            line-height: 1.4;
        }

        /* å‚™è¨»å€åŸŸæ¨£å¼ */
        .notes-section {
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
        }

        .notes-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .notes-toggle {
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .notes-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .notes-content {
            padding: 15px;
            display: block;
        }

        .notes-content.collapsed {
            display: none;
        }

        .notes-textarea {
            width: 100%;
            min-height: 80px;
            max-height: 200px;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .notes-textarea.modified {
            border-color: #ffc107;
            background-color: #fffbf0;
        }

        .notes-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .notes-status {
            font-size: 0.85rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #f8f9fa;
            color: #6c757d;
        }

        .notes-status.saved {
            background: #d4edda;
            color: #155724;
        }

        .notes-status.modified {
            background: #fff3cd;
            color: #856404;
        }

        .notes-timestamp {
            font-size: 0.8rem;
            color: #868e96;
        }

        /* æª”æ¡ˆå‚™è¨»å€åŸŸæ¨£å¼ */
        .file-notes-section {
            margin-top: 20px;
            background: rgba(255, 248, 240, 0.8);
            border-radius: 8px;
            border: 1px solid #ffd54f;
            overflow: hidden;
        }

        .file-notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            border-bottom: 1px solid #ffd54f;
            cursor: pointer;
        }

        .file-notes-label {
            font-weight: 600;
            color: #f57c00;
            font-size: 0.95rem;
            cursor: pointer;
        }

        .file-notes-toggle {
            background: none;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            color: #f57c00;
        }

        .file-notes-toggle:hover {
            background: rgba(245, 124, 0, 0.1);
        }

        .file-notes-content {
            padding: 15px;
            display: block;
        }

        .file-notes-content.collapsed {
            display: none;
        }

        .file-notes-textarea {
            width: 100%;
            min-height: 100px;
            max-height: 300px;
            padding: 12px;
            border: 1px solid #ffcc02;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fffef7;
        }

        .file-notes-textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.25);
        }

        .file-notes-textarea.modified {
            border-color: #ff5722;
            background-color: #fff3e0;
        }

        .file-notes-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ffecb3;
        }

        .file-notes-status {
            font-size: 0.85rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #fff8e1;
            color: #e65100;
        }

        .file-notes-status.saved {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .file-notes-status.modified {
            background: #fff3e0;
            color: #d84315;
        }

        .file-notes-timestamp {
            font-size: 0.8rem;
            color: #bf360c;
        }

        .ai-analysis {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border-radius: 10px;
            padding: 25px;
            line-height: 1.6;
        }

        .ai-analysis h2, .ai-analysis h3 {
            color: #7b1fa2;
            margin-bottom: 15px;
        }

        .ai-analysis h2 {
            font-size: 1.5rem;
            border-bottom: 2px solid #7b1fa2;
            padding-bottom: 10px;
        }

        .ai-analysis h3 {
            font-size: 1.2rem;
            margin-top: 25px;
        }

        .ai-analysis p {
            margin-bottom: 15px;
            color: #333;
        }

        .ai-analysis ul, .ai-analysis ol {
            margin-bottom: 15px;
            padding-left: 20px;
        }

        .ai-analysis li {
            margin-bottom: 8px;
        }

        .ai-analysis table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ai-analysis th, .ai-analysis td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .ai-analysis th {
            background: #7b1fa2;
            color: white;
            font-weight: bold;
        }

        .ai-analysis tr:hover {
            background: #f5f5f5;
        }

        .conversation-history {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .conversation-message {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.5;
        }

        .user-message {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .ai-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 30px;
            background: #f8f9fa;
        }

        .export-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .export-btn.secondary {
            background: linear-gradient(135deg, #2196f3, #42a5f5);
        }

        .export-btn.secondary:hover {
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .ask-stan-btn {
            background: linear-gradient(135deg, #9c27b0, #ba68c8);
        }

        .ask-stan-btn:hover {
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
        }

        .ask-stan-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .variables-grid,
            .search-terms,
            .loinc-details {
                grid-template-columns: 1fr;
            }

            .section-header {
                padding: 15px 20px;
            }

            /* å‚™è¨»å€åŸŸéŸ¿æ‡‰å¼æ¨£å¼ */
            .notes-section {
                margin-top: 10px;
            }

            .notes-header {
                padding: 10px 12px;
            }

            .notes-label {
                font-size: 0.9rem;
            }

            .notes-textarea {
                min-height: 60px;
                font-size: 0.85rem;
                padding: 10px;
            }

            .notes-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .notes-status,
            .notes-timestamp {
                font-size: 0.8rem;
            }

            .section-content.expanded {
                padding: 20px;
            }

            .export-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        .metadata-info {
            background: linear-gradient(135deg, #fff8e1, #ffecb3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metadata-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
        }

        .metadata-label {
            font-weight: bold;
            color: #f57c00;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .metadata-value {
            color: #333;
        }

        /* æª”æ¡ˆæ§åˆ¶æ¨£å¼ */
        .file-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-weight: bold;
            color: #1a73e8;
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }

        .refresh-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .refresh-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(76, 175, 80, 0.4);
            background: linear-gradient(135deg, #45a049, #5cb85c);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* è¡¨æ ¼æª¢è¦–æ¨£å¼ */
        .file-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .file-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .file-table th {
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s ease;
        }

        .file-table th:hover {
            background: linear-gradient(135deg, #1557b0, #3367d6);
        }

        .file-table .sort-icon {
            margin-left: 5px;
            font-size: 0.8rem;
        }

        .file-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }

        .file-table tbody tr {
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .file-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .file-table tbody tr.selected {
            background-color: #e3f2fd;
        }

        .table-filename {
            font-weight: bold;
            color: #1a73e8;
        }

        .table-search-terms {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-rank {
            text-align: center;
            font-weight: bold;
            color: #ff9800;
        }

        .table-local-id {
            font-family: monospace;
            color: #1a73e8;
            font-weight: bold;
        }

        .table-local-code {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #2e7d32;
            font-weight: bold;
        }

        .table-loinc-codes {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: monospace;
            color: #d32f2f;
            font-weight: bold;
        }

        .table-institution {
            font-weight: bold;
            color: #673ab7;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-timestamp {
            color: #666;
            font-size: 0.9rem;
        }

        .table-file-notes {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #666;
            font-size: 0.9rem;
        }

        .table-file-notes:hover {
            white-space: normal;
            word-wrap: break-word;
        }

        .table-actions {
            text-align: center;
        }

        .view-btn {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(76, 175, 80, 0.4);
        }

        .delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
        }

        .delete-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px) scale(1.1);
            box-shadow: 0 3px 8px rgba(244, 67, 54, 0.4);
        }

        .table-actions {
            text-align: center;
            white-space: nowrap;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .file-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }

            .control-group select,
            .control-group input {
                min-width: auto;
                width: 100%;
            }

            .file-table {
                overflow-x: auto;
            }

            .file-table table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” LOINC æ˜ å°„çµæœæŸ¥çœ‹å™¨</h1>
            <p>æŸ¥çœ‹å’Œåˆ†æå·²å„²å­˜çš„ LOINC æ˜ å°„çµæœ</p>
        </div>

        <div class="file-selector">
            <h2>ğŸ“ é¸æ“‡è¦æŸ¥çœ‹çš„çµæœæª”æ¡ˆ</h2>
            
            <!-- æ’åºå’Œé¡¯ç¤ºé¸é … -->
            <div class="file-controls">
                <div class="control-group">
                    <label for="institutionFilter">é†«ç™‚æ©Ÿæ§‹:</label>
                    <select id="institutionFilter" onchange="loadFileList()">
                        <option value="all">æ‰€æœ‰æ©Ÿæ§‹</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="sortBy">æ’åºä¾æ“š:</label>
                    <select id="sortBy" onchange="applyFiltersAndSort()">
                        <option value="institution">é†«ç™‚æ©Ÿæ§‹ (A-Z)</option>
                        <option value="rank" selected>Rank (ä½åˆ°é«˜)</option>
                        <option value="rank-desc">Rank (é«˜åˆ°ä½)</option>
                        <option value="localId">Local ID (A-Z)</option>
                        <option value="localCode">Local Code (A-Z)</option>
                        <option value="loincCode">LOINC Code (A-Z)</option>
                        <option value="searchTerms">æœå°‹è©èª (A-Z)</option>
                        <option value="timestamp">å»ºç«‹æ™‚é–“ (æ–°åˆ°èˆŠ)</option>
                        <option value="timestamp-asc">å»ºç«‹æ™‚é–“ (èˆŠåˆ°æ–°)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="viewMode">é¡¯ç¤ºæ¨¡å¼:</label>
                    <select id="viewMode" onchange="changeViewMode()">
                        <option value="grid">å¡ç‰‡æª¢è¦–</option>
                        <option value="table" selected>è¡¨æ ¼æª¢è¦–</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="filterText">ç¯©é¸:</label>
                    <input type="text" id="filterText" placeholder="æœå°‹æª”æ¡ˆ..." onkeyup="applyFiltersAndSort()">
                </div>
                
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button id="refreshBtn" class="refresh-btn" onclick="refreshFileList()" title="é‡æ–°è¼‰å…¥æª”æ¡ˆåˆ—è¡¨">
                        ğŸ”„ é‡æ–°è¼‰å…¥
                    </button>
                </div>
            </div>
            
            <div id="fileList" class="file-list" style="display: none;">
                <div class="loading">è¼‰å…¥æª”æ¡ˆåˆ—è¡¨ä¸­...</div>
            </div>
            
            <!-- è¡¨æ ¼æª¢è¦– -->
            <div id="fileTable" class="file-table">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('institution')">é†«ç™‚æ©Ÿæ§‹ <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortTable('rank')">Rank <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortTable('localId')">Local ID <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortTable('localCode')">Local Code <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortTable('loincCode')">LOINC Code <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortTable('searchTerms')">æœå°‹è©èª <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortTable('fileNotes')">å‚™è¨» <span class="sort-icon">â†•ï¸</span></th>
                            <th onclick="sortTable('timestamp')">å»ºç«‹æ™‚é–“ <span class="sort-icon">â†•ï¸</span></th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="fileTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="mainContent" class="main-content">
            <div class="content-header">
                <h1 id="contentTitle">LOINC æ˜ å°„çµæœ</h1>
                <div id="contentTimestamp" class="timestamp"></div>
            </div>

            <div class="content-body">
                <!-- è¼¸å…¥è®Šæ•¸å€æ®µ -->
                <div class="section">
                    <div class="section-header active" onclick="toggleSection(this, 'inputVariables')">
                        <div class="section-title">
                            <span class="section-icon">ğŸ“‹</span>
                            è¼¸å…¥è®Šæ•¸ç¸½è¦½
                        </div>
                        <span class="expand-icon expanded">â–¼</span>
                    </div>
                    <div id="inputVariables" class="section-content expanded">
                        <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æœå°‹è³‡è¨Šå€æ®µ -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this, 'searchInfo')">
                        <div class="section-title">
                            <span class="section-icon">ğŸ”</span>
                            æœå°‹æ¢ä»¶
                        </div>
                        <span class="expand-icon">â–¼</span>
                    </div>
                    <div id="searchInfo" class="section-content">
                        <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- é¸æ“‡çš„ LOINC ä»£ç¢¼å€æ®µ -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this, 'loincResults')">
                        <div class="section-title">
                            <span class="section-icon">ğŸ¯</span>
                            é¸æ“‡çš„ LOINC ä»£ç¢¼
                        </div>
                        <span class="expand-icon">â–¼</span>
                    </div>
                    <div id="loincResults" class="section-content">
                        <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- AI åˆ†æçµæœå€æ®µ -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this, 'aiAnalysis')">
                        <div class="section-title">
                            <span class="section-icon">ğŸ¤–</span>
                            AI åˆ†æçµæœ
                        </div>
                        <span class="expand-icon">â–¼</span>
                    </div>
                    <div id="aiAnalysis" class="section-content">
                        <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å°è©±æ­·å²å€æ®µ -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this, 'conversationHistory')">
                        <div class="section-title">
                            <span class="section-icon">ğŸ’¬</span>
                            AI å°è©±æ­·å²
                        </div>
                        <span class="expand-icon">â–¼</span>
                    </div>
                    <div id="conversationHistory" class="section-content">
                        <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æª”æ¡ˆè³‡è¨Šå€æ®µ -->
                <div class="section">
                    <div class="section-header" onclick="toggleSection(this, 'metadataInfo')">
                        <div class="section-title">
                            <span class="section-icon">â„¹ï¸</span>
                            æª”æ¡ˆè³‡è¨Š ğŸ“
                        </div>
                        <span class="expand-icon">â–¼</span>
                    </div>
                    <div id="metadataInfo" class="section-content">
                        <!-- å‹•æ…‹å…§å®¹å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <div class="export-buttons">
                <button class="export-btn" onclick="exportToJson()">
                    ğŸ“„ å°å‡ºç‚º JSON
                </button>
                <button class="export-btn secondary" onclick="exportToPdf()">
                    ğŸ“‘ å°å‡ºç‚º PDF
                </button>
                <button class="export-btn secondary" onclick="printReport()">
                    ğŸ–¨ï¸ åˆ—å°å ±å‘Š
                </button>
                <button class="export-btn ask-stan-btn" onclick="askStan()" id="askStanBtn" disabled>
                    ğŸ¤– Ask Stan
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let fileList = [];
        let filteredFileList = [];
        let currentSortField = 'rank';
        let currentSortDirection = 'asc';

        // è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
        async function loadFileList() {
            try {
                const institutionFilter = document.getElementById('institutionFilter').value;
                const queryParam = institutionFilter === 'all' ? '' : `?institution=${encodeURIComponent(institutionFilter)}`;
                
                const response = await fetch(`/api/get-saved-mappings${queryParam}`);
                const data = await response.json();
                
                if (data.success && data.files) {
                    fileList = data.files;
                    filteredFileList = [...fileList];
                    
                    // æ›´æ–°æ©Ÿæ§‹é¸æ“‡å™¨
                    updateInstitutionFilter(data.institutions, data.currentInstitution);
                    
                    applyFiltersAndSort();
                } else {
                    document.getElementById('fileList').innerHTML = 
                        '<div class="error">ç„¡æ³•è¼‰å…¥æª”æ¡ˆåˆ—è¡¨: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤') + '</div>';
                }
            } catch (error) {
                console.error('è¼‰å…¥æª”æ¡ˆåˆ—è¡¨å¤±æ•—:', error);
                document.getElementById('fileList').innerHTML = 
                    '<div class="error">è¼‰å…¥æª”æ¡ˆåˆ—è¡¨å¤±æ•—: ' + error.message + '</div>';
            }
        }

        // é‡æ–°è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
        async function refreshFileList() {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.textContent;
            
            try {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'ğŸ”„ è¼‰å…¥ä¸­...';
                
                // é‡æ–°è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
                await loadFileList();
                
                // é¡¯ç¤ºæˆåŠŸç‹€æ…‹
                refreshBtn.textContent = 'âœ… å·²æ›´æ–°';
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                }, 1500);
                
            } catch (error) {
                console.error('é‡æ–°è¼‰å…¥å¤±æ•—:', error);
                refreshBtn.textContent = 'âŒ å¤±æ•—';
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }
        
        // æ›´æ–°æ©Ÿæ§‹ç¯©é¸å™¨
        function updateInstitutionFilter(institutions, currentInstitution) {
            const select = document.getElementById('institutionFilter');
            const currentValue = select.value;
            
            // æ¸…é™¤ç¾æœ‰é¸é …ï¼ˆé™¤äº†"æ‰€æœ‰æ©Ÿæ§‹"ï¼‰
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // æ·»åŠ æ©Ÿæ§‹é¸é …
            institutions.forEach(institution => {
                const option = document.createElement('option');
                option.value = institution;
                option.textContent = institution;
                select.appendChild(option);
            });
            
            // è¨­ç½®ç•¶å‰é¸ä¸­çš„å€¼
            if (currentValue && institutions.includes(currentValue)) {
                select.value = currentValue;
            } else if (currentInstitution && currentInstitution !== 'all') {
                select.value = currentInstitution;
            }
        }

        // ç¯©é¸å’Œæ’åºå‡½æ•¸
        function applyFiltersAndSort() {
            const filterText = document.getElementById('filterText').value.toLowerCase();
            const sortBy = document.getElementById('sortBy').value;
            
            // ç¯©é¸æª”æ¡ˆ
            filteredFileList = fileList.filter(file => {
                if (!filterText) return true;
                
                const searchable = [
                    file.filename,
                    file.searchTerms || '',
                    file.selectedLoincCodes?.join(' ') || ''
                ].join(' ').toLowerCase();
                
                return searchable.includes(filterText);
            });
            
            // æ’åºæª”æ¡ˆ
            sortFileList(sortBy);
            
            // é¡¯ç¤ºçµæœ
            const viewMode = document.getElementById('viewMode').value;
            if (viewMode === 'table') {
                displayFileTable(filteredFileList);
            } else {
                displayFileList(filteredFileList);
            }
        }
        
        // æ’åºå‡½æ•¸
        function sortFileList(sortBy) {
            filteredFileList.sort((a, b) => {
                let valueA, valueB;
                
                switch(sortBy) {
                    case 'institution':
                        valueA = (a.institution || '').toLowerCase();
                        valueB = (b.institution || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'rank':
                        valueA = parseInt(a.rank) || 999999;
                        valueB = parseInt(b.rank) || 999999;
                        return valueA - valueB; // ä½åˆ°é«˜
                    case 'rank-desc':
                        valueA = parseInt(a.rank) || 999999;
                        valueB = parseInt(b.rank) || 999999;
                        return valueB - valueA; // é«˜åˆ°ä½
                    case 'localId':
                        valueA = (a.localId || '').toLowerCase();
                        valueB = (b.localId || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'localCode':
                        valueA = (a.localCode || '').toLowerCase();
                        valueB = (b.localCode || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'loincCode':
                        valueA = (a.loincCodes || '').toLowerCase();
                        valueB = (b.loincCodes || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'timestamp':
                        valueA = new Date(a.timestamp);
                        valueB = new Date(b.timestamp);
                        return valueB - valueA; // æ–°åˆ°èˆŠ
                    case 'timestamp-asc':
                        valueA = new Date(a.timestamp);
                        valueB = new Date(b.timestamp);
                        return valueA - valueB; // èˆŠåˆ°æ–°
                    case 'searchTerms':
                        valueA = (a.searchTerms || '').toLowerCase();
                        valueB = (b.searchTerms || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    default:
                        return 0;
                }
            });
        }
        
        // æ”¹è®Šæª¢è¦–æ¨¡å¼
        function changeViewMode() {
            const viewMode = document.getElementById('viewMode').value;
            const fileListDiv = document.getElementById('fileList');
            const fileTableDiv = document.getElementById('fileTable');
            const sortBy = document.getElementById('sortBy');
            
            if (viewMode === 'table') {
                fileListDiv.style.display = 'none';
                fileTableDiv.style.display = 'block';
                // å•Ÿç”¨æ‰€æœ‰æ’åºé¸é …
                for (let option of sortBy.options) {
                    option.disabled = false;
                }
                displayFileTable(filteredFileList);
            } else {
                fileListDiv.style.display = 'grid';
                fileTableDiv.style.display = 'none';
                // ç¦ç”¨ rank æ’åºé¸é …ï¼ˆå¡ç‰‡æª¢è¦–æ²’æœ‰è©³ç´°è³‡æ–™ï¼‰
                for (let option of sortBy.options) {
                    if (option.value === 'rank' || option.value === 'rank-desc' || 
                        option.value === 'localId' || option.value === 'localCode' || 
                        option.value === 'loincCode') {
                        option.disabled = true;
                    } else {
                        option.disabled = false;
                    }
                }
                // å¦‚æœç•¶å‰é¸æ“‡çš„æ˜¯è¢«ç¦ç”¨çš„é¸é …ï¼Œåˆ‡æ›åˆ°æ™‚é–“æ’åº
                if (sortBy.value === 'rank' || sortBy.value === 'rank-desc' || 
                    sortBy.value === 'localId' || sortBy.value === 'localCode' || 
                    sortBy.value === 'loincCode') {
                    sortBy.value = 'timestamp';
                    applyFiltersAndSort();
                } else {
                    displayFileList(filteredFileList);
                }
            }
        }
        
        // åˆ†é è®Šæ•¸
        let currentPage = 0;
        const itemsPerPage = 5;
        let allFiles = [];

        // é¡¯ç¤ºæª”æ¡ˆåˆ—è¡¨ (å¡ç‰‡æª¢è¦–)
        async function displayFileList(files) {
            allFiles = files;
            currentPage = 0;
            const fileListDiv = document.getElementById('fileList');
            
            if (files.length === 0) {
                fileListDiv.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‚</div>
                        <h3>æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æª”æ¡ˆ</h3>
                        <p>è«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–æª¢æŸ¥æ˜¯å¦æœ‰å·²å„²å­˜çš„æ˜ å°„çµæœ</p>
                    </div>
                `;
                return;
            }

            renderFileList();
        }

        // æ¸²æŸ“æª”æ¡ˆåˆ—è¡¨ï¼ˆåˆ†é ï¼‰
        function renderFileList() {
            const fileListDiv = document.getElementById('fileList');
            const startIndex = currentPage * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentFiles = allFiles.slice(startIndex, endIndex);
            
            // é¡¯ç¤ºç•¶å‰é é¢çš„æª”æ¡ˆ
            fileListDiv.innerHTML = currentFiles.map(file => {
                const date = new Date(file.timestamp).toLocaleString('zh-TW');
                const searchTerms = file.searchTerms || 'æœªæŒ‡å®š';
                const loincCount = file.selectedLoincCodes ? file.selectedLoincCodes.length : 0;
                const fileSize = formatFileSize(file.size || 0);
                
                return `
                    <div class="file-item" onclick="loadMappingData('${file.filename}')" data-filename="${file.filename}">
                        <div class="file-item-header">
                            <div class="file-name">${file.filename}</div>
                            <button class="delete-btn-card" onclick="event.stopPropagation(); confirmDeleteFile('${file.filename}')" title="åˆªé™¤æª”æ¡ˆ">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                        <div class="file-info">
                            <div>ğŸ¥ æ©Ÿæ§‹: ${file.institution || 'æœªæŒ‡å®š'}</div>
                            <div>ğŸ“… ${date}</div>
                            <div>ğŸ” æœå°‹è©: ${searchTerms}</div>
                            <div>ğŸ¯ é¸æ“‡ä»£ç¢¼: ${loincCount} å€‹</div>
                            <div>ğŸ“„ æª”æ¡ˆå¤§å°: ${fileSize}</div>
                            <div class="file-notes-placeholder" data-filename="${file.filename}">ğŸ“ é»æ“ŠæŸ¥çœ‹å‚™è¨»</div>
                        </div>
                    </div>
                `;
            }).join('');

            // æ·»åŠ åˆ†é æ§åˆ¶
            const totalPages = Math.ceil(allFiles.length / itemsPerPage);
            if (totalPages > 1) {
                fileListDiv.innerHTML += `
                    <div class="pagination-controls">
                        <button onclick="previousPage()" ${currentPage === 0 ? 'disabled' : ''} class="pagination-btn">
                            â† ä¸Šä¸€é 
                        </button>
                        <span class="pagination-info">
                            ç¬¬ ${currentPage + 1} é ï¼Œå…± ${totalPages} é  (${allFiles.length} å€‹æª”æ¡ˆ)
                        </span>
                        <button onclick="nextPage()" ${currentPage >= totalPages - 1 ? 'disabled' : ''} class="pagination-btn">
                            ä¸‹ä¸€é  â†’
                        </button>
                    </div>
                `;
            }
            
            // å‚™è¨»å°‡åœ¨é»æ“Šæª”æ¡ˆæ™‚è¼‰å…¥ï¼Œé¿å…æ€§èƒ½å•é¡Œ
        }

        // ä¸Šä¸€é 
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                // æ ¹æ“šç•¶å‰è¦–åœ–æ¨¡å¼é‡æ–°æ¸²æŸ“
                if (document.getElementById('fileList').style.display !== 'none') {
                    renderFileList(); // å¡ç‰‡è¦–åœ–
                } else {
                    // è¡¨æ ¼è¦–åœ–ï¼šé‡æ–°è¼‰å…¥ä¸¦æ’åºæ‰€æœ‰æª”æ¡ˆ
                    loadFileDetailsForTable(allFiles);
                }
            }
        }

        // ä¸‹ä¸€é 
        function nextPage() {
            const totalPages = Math.ceil(allFiles.length / itemsPerPage);
            if (currentPage < totalPages - 1) {
                currentPage++;
                // æ ¹æ“šç•¶å‰è¦–åœ–æ¨¡å¼é‡æ–°æ¸²æŸ“
                if (document.getElementById('fileList').style.display !== 'none') {
                    renderFileList(); // å¡ç‰‡è¦–åœ–
                } else {
                    // è¡¨æ ¼è¦–åœ–ï¼šé‡æ–°è¼‰å…¥ä¸¦æ’åºæ‰€æœ‰æª”æ¡ˆ
                    loadFileDetailsForTable(allFiles);
                }
            }
        }
        
        // è¼‰å…¥å–®å€‹æª”æ¡ˆçš„å‚™è¨»ç”¨æ–¼å¡ç‰‡æª¢è¦–
        async function loadFileNotesForCard(filename) {
            try {
                const response = await fetch(`/api/get-mapping-file/${filename}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    const fileNotes = data.data.fileNotes || '';
                    const fileNotesPreview = fileNotes.length > 50 ? fileNotes.substring(0, 50) + '...' : fileNotes;
                    
                    // æ›´æ–°å°æ‡‰å¡ç‰‡çš„å‚™è¨»é¡¯ç¤º
                    const placeholder = document.querySelector(`[data-filename="${filename}"] .file-notes-placeholder`);
                    if (placeholder) {
                        if (fileNotesPreview) {
                            placeholder.innerHTML = `ğŸ“ å‚™è¨»: ${fileNotesPreview}`;
                            placeholder.style.color = '';
                        } else {
                            placeholder.innerHTML = 'ğŸ“ ç„¡å‚™è¨»';
                            placeholder.style.color = '#999';
                        }
                    }
                }
            } catch (error) {
                console.error(`è¼‰å…¥æª”æ¡ˆ ${filename} å‚™è¨»å¤±æ•—:`, error);
                const placeholder = document.querySelector(`[data-filename="${filename}"] .file-notes-placeholder`);
                if (placeholder) {
                    placeholder.innerHTML = 'ğŸ“ ç„¡å‚™è¨»';
                    placeholder.style.color = '#999';
                }
            }
        }
        
        // é¡¯ç¤ºæª”æ¡ˆè¡¨æ ¼ (è¡¨æ ¼æª¢è¦–)
        function displayFileTable(files) {
            const tableBody = document.getElementById('fileTableBody');
            
            if (files.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æª”æ¡ˆ
                        </td>
                    </tr>
                `;
                return;
            }
            
            // è¨­ç½® allFiles ä¸¦é‡ç½®åˆ†é 
            allFiles = files;
            currentPage = 0;
            
            // è¼‰å…¥æª”æ¡ˆå…§å®¹ä»¥å–å¾—è©³ç´°è³‡è¨Š
            loadFileDetailsForTable(files);
        }
        
        // è¼‰å…¥æª”æ¡ˆè©³ç´°è³‡è¨Šç”¨æ–¼è¡¨æ ¼é¡¯ç¤º
        async function loadFileDetailsForTable(files) {
            const tableBody = document.getElementById('fileTableBody');
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            tableBody.innerHTML = `
                <tr>
                    <td colspan="9" style="text-align: center; padding: 40px; color: #666;">
                        è¼‰å…¥è©³ç´°è³‡è¨Šä¸­...
                    </td>
                </tr>
            `;
            
            // ä½¿ç”¨å„ªåŒ–çš„ APIï¼Œåªè¼‰å…¥æ’åºæ‰€éœ€çš„æ¬„ä½
            console.log(`é–‹å§‹è¼‰å…¥ ${files.length} å€‹æª”æ¡ˆçš„æ’åºè³‡æ–™...`);
            
            try {
                const filenames = files.map(file => file.filename);
                const response = await fetch('/api/get-sorting-fields', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ filenames: filenames })
                });
                
                const data = await response.json();
                
                if (data.success && data.data) {
                    const detailedFiles = data.data.map(file => ({
                        ...file,
                        timestamp: new Date(file.timestamp).toLocaleString('zh-TW')
                    }));
                    
                    console.log(`è¼‰å…¥å®Œæˆï¼Œå…± ${detailedFiles.length} å€‹æœ‰æ•ˆæª”æ¡ˆ`);
                    
                    // æ ¹æ“šç•¶å‰æ’åºè¨­å®šå°è©³ç´°æª”æ¡ˆé€²è¡Œå…¨å±€æ’åº
                    const sortBy = document.getElementById('sortBy').value;
                    sortDetailedFiles(detailedFiles, sortBy);
                    
                    // å…¨å±€æ’åºå¾Œï¼Œåªé¡¯ç¤ºç•¶å‰é é¢çš„æª”æ¡ˆ
                    const startIndex = currentPage * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const currentPageFiles = detailedFiles.slice(startIndex, endIndex);
                    
                    // é¡¯ç¤ºè©³ç´°è¡¨æ ¼
                    renderDetailedTable(currentPageFiles);
                } else {
                    console.error('è¼‰å…¥æ’åºè³‡æ–™å¤±æ•—:', data.error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #e74c3c;">
                                è¼‰å…¥å¤±æ•—: ${data.error || 'æœªçŸ¥éŒ¯èª¤'}
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('è¼‰å…¥æ’åºè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #e74c3c;">
                            è¼‰å…¥å¤±æ•—: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        // å°è©³ç´°æª”æ¡ˆé€²è¡Œæ’åº
        function sortDetailedFiles(detailedFiles, sortBy) {
            detailedFiles.sort((a, b) => {
                let valueA, valueB;
                
                switch(sortBy) {
                    case 'institution':
                        valueA = (a.institution || '').toLowerCase();
                        valueB = (b.institution || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'rank':
                        // ç¢ºä¿æ­£ç¢ºè§£ææ•¸å­—ï¼Œè™•ç†å­—ç¬¦ä¸²å’Œæ•¸å­—
                        valueA = typeof a.rank === 'string' ? parseInt(a.rank, 10) : (a.rank || 999999);
                        valueB = typeof b.rank === 'string' ? parseInt(b.rank, 10) : (b.rank || 999999);
                        // å¦‚æœè§£æå¤±æ•—ï¼Œä½¿ç”¨ 999999
                        if (isNaN(valueA)) valueA = 999999;
                        if (isNaN(valueB)) valueB = 999999;
                        return valueA - valueB; // ä½åˆ°é«˜
                    case 'rank-desc':
                        // ç¢ºä¿æ­£ç¢ºè§£ææ•¸å­—ï¼Œè™•ç†å­—ç¬¦ä¸²å’Œæ•¸å­—
                        valueA = typeof a.rank === 'string' ? parseInt(a.rank, 10) : (a.rank || 999999);
                        valueB = typeof b.rank === 'string' ? parseInt(b.rank, 10) : (b.rank || 999999);
                        // å¦‚æœè§£æå¤±æ•—ï¼Œä½¿ç”¨ 999999
                        if (isNaN(valueA)) valueA = 999999;
                        if (isNaN(valueB)) valueB = 999999;
                        return valueB - valueA; // é«˜åˆ°ä½
                    case 'localId':
                        valueA = (a.localId || '').toLowerCase();
                        valueB = (b.localId || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'localCode':
                        valueA = (a.localCode || '').toLowerCase();
                        valueB = (b.localCode || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'loincCode':
                        valueA = (a.loincCodes || '').toLowerCase();
                        valueB = (b.loincCodes || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'searchTerms':
                        valueA = (a.searchTerms || '').toLowerCase();
                        valueB = (b.searchTerms || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'fileNotes':
                        valueA = (a.fileNotes || '').toLowerCase();
                        valueB = (b.fileNotes || '').toLowerCase();
                        return valueA.localeCompare(valueB);
                    case 'timestamp':
                        valueA = new Date(a.timestamp);
                        valueB = new Date(b.timestamp);
                        return valueB - valueA; // æ–°åˆ°èˆŠ
                    case 'timestamp-asc':
                        valueA = new Date(a.timestamp);
                        valueB = new Date(b.timestamp);
                        return valueA - valueB; // èˆŠåˆ°æ–°
                    default:
                        return 0;
                }
            });
        }

        // æ¸²æŸ“è©³ç´°è¡¨æ ¼
        function renderDetailedTable(detailedFiles) {
            const tableBody = document.getElementById('fileTableBody');
            
            tableBody.innerHTML = detailedFiles.map(file => {
                return `
                    <tr onclick="loadMappingData('${file.filename}')" data-filename="${file.filename}">
                        <td class="table-institution">${file.institution || 'æœªæŒ‡å®š'}</td>
                        <td class="table-rank">${file.rank === 999999 ? 'æœªæŒ‡å®š' : file.rank}</td>
                        <td class="table-local-id">${file.localId}</td>
                        <td class="table-local-code" title="${file.localCode}">${file.localCode}</td>
                        <td class="table-loinc-codes" title="${file.loincCodes}">${file.loincCodes}</td>
                        <td class="table-search-terms" title="${file.searchTerms}">${file.searchTerms}</td>
                        <td class="table-file-notes" title="${file.fileNotes}">
                            ${file.fileNotesPreview ? `ğŸ“ ${file.fileNotesPreview}` : 'ç„¡å‚™è¨»'}
                        </td>
                        <td class="table-timestamp">${file.timestamp}</td>
                        <td class="table-actions">
                            <button class="view-btn" onclick="event.stopPropagation(); loadMappingData('${file.filename}')">
                                æŸ¥çœ‹
                            </button>
                            <button class="delete-btn" onclick="event.stopPropagation(); confirmDeleteFile('${file.filename}')" title="åˆªé™¤æª”æ¡ˆ">
                                ğŸ—‘ï¸
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // æ·»åŠ åˆ†é æ§åˆ¶åˆ°è¡¨æ ¼ä¸‹æ–¹
            const totalPages = Math.ceil(allFiles.length / itemsPerPage);
            if (totalPages > 1) {
                const paginationDiv = document.createElement('div');
                paginationDiv.className = 'pagination-controls';
                paginationDiv.innerHTML = `
                    <button onclick="previousPage()" ${currentPage === 0 ? 'disabled' : ''} class="pagination-btn">
                        â† ä¸Šä¸€é 
                    </button>
                    <span class="pagination-info">
                        ç¬¬ ${currentPage + 1} é ï¼Œå…± ${totalPages} é  (${allFiles.length} å€‹æª”æ¡ˆ)
                    </span>
                    <button onclick="nextPage()" ${currentPage >= totalPages - 1 ? 'disabled' : ''} class="pagination-btn">
                        ä¸‹ä¸€é  â†’
                    </button>
                `;
                
                // ç§»é™¤èˆŠçš„åˆ†é æ§åˆ¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const oldPagination = document.querySelector('.pagination-controls');
                if (oldPagination) {
                    oldPagination.remove();
                }
                
                // å°‡åˆ†é æ§åˆ¶æ·»åŠ åˆ°è¡¨æ ¼å®¹å™¨ä¸­
                const tableContainer = document.querySelector('#fileTable');
                if (tableContainer) {
                    tableContainer.appendChild(paginationDiv);
                }
            }
        }
        
        // è¡¨æ ¼æ’åº
        function sortTable(field) {
            // åˆ‡æ›æ’åºæ–¹å‘ä¸¦è¨­å®šä¸‹æ‹‰é¸å–®å€¼
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            
            // æ›´æ–°ä¸‹æ‹‰é¸å–®çš„å€¼
            const sortBy = document.getElementById('sortBy');
            if (field === 'rank') {
                sortBy.value = currentSortDirection === 'asc' ? 'rank' : 'rank-desc';
            } else if (field === 'timestamp') {
                sortBy.value = currentSortDirection === 'asc' ? 'timestamp-asc' : 'timestamp';
            } else {
                sortBy.value = field;
            }
            
            // æ›´æ–°æ’åºåœ–ç¤º
            updateSortIcons(field);
            
            // é‡æ–°è¼‰å…¥ä¸¦é¡¯ç¤ºè¡¨æ ¼
            displayFileTable(filteredFileList);
        }
        
        // æ›´æ–°æ’åºåœ–ç¤º
        function updateSortIcons(activeField) {
            const icons = document.querySelectorAll('.sort-icon');
            icons.forEach(icon => {
                icon.textContent = 'â†•ï¸';
            });
            
            const activeIcon = document.querySelector(`th[onclick*="${activeField}"] .sort-icon`);
            if (activeIcon) {
                activeIcon.textContent = currentSortDirection === 'asc' ? 'â†‘' : 'â†“';
            }
        }
        
        // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // è¼‰å…¥æ˜ å°„è³‡æ–™
        async function loadMappingData(filename) {
            try {
                // è¨­ç½®ç•¶å‰æª”æ¡ˆåç¨±ä¾›å‚™è¨»åŠŸèƒ½ä½¿ç”¨
                currentFileName = filename;
                
                // æ›´æ–°é¸ä¸­ç‹€æ…‹ (å¡ç‰‡æª¢è¦–)
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // æ›´æ–°é¸ä¸­ç‹€æ…‹ (è¡¨æ ¼æª¢è¦–)
                document.querySelectorAll('.file-table tbody tr').forEach(row => {
                    row.classList.remove('selected');
                });
                
                // æ‰¾åˆ°å°æ‡‰çš„å…ƒç´ ä¸¦æ¨™è¨˜ç‚ºé¸ä¸­
                const targetCard = Array.from(document.querySelectorAll('.file-item')).find(item => 
                    item.onclick && item.onclick.toString().includes(filename)
                );
                if (targetCard) targetCard.classList.add('selected');
                
                const targetRow = document.querySelector(`tr[data-filename="${filename}"]`);
                if (targetRow) targetRow.classList.add('selected');

                const response = await fetch(`/api/get-mapping-file/${filename}`);
                const data = await response.json();
                
                if (data.success) {
                    currentData = data.data;
                    displayMappingData(currentData);
                    document.getElementById('mainContent').classList.add('show');
                } else {
                    alert('è¼‰å…¥æª”æ¡ˆå¤±æ•—: ' + (data.error || 'æœªçŸ¥éŒ¯èª¤'));
                    // è¼‰å…¥å¤±æ•—æ™‚ç¦ç”¨ Ask Stan æŒ‰éˆ•
                    const askStanBtn = document.getElementById('askStanBtn');
                    if (askStanBtn) {
                        askStanBtn.disabled = true;
                        askStanBtn.textContent = 'ğŸ¤– Ask Stan';
                        askStanBtn.style.background = '#cccccc';
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥æª”æ¡ˆå¤±æ•—:', error);
                alert('è¼‰å…¥æª”æ¡ˆå¤±æ•—: ' + error.message);
                // è¼‰å…¥å¤±æ•—æ™‚ç¦ç”¨ Ask Stan æŒ‰éˆ•
                const askStanBtn = document.getElementById('askStanBtn');
                if (askStanBtn) {
                    askStanBtn.disabled = true;
                    askStanBtn.textContent = 'ğŸ¤– Ask Stan';
                    askStanBtn.style.background = '#cccccc';
                }
            }
        }

        // é¡¯ç¤ºæ˜ å°„è³‡æ–™
        function displayMappingData(data) {
            // æ›´æ–°æ¨™é¡Œå’Œæ™‚é–“æˆ³è¨˜
            document.getElementById('contentTitle').textContent = 
                `LOINC æ˜ å°„çµæœ - ${data.search?.searchTerms || 'æœªæŒ‡å®šæœå°‹è©'}`;
            
            const timestamp = new Date(data.metadata?.timestamp || data.timestamp).toLocaleString('zh-TW');
            document.getElementById('contentTimestamp').textContent = `å»ºç«‹æ™‚é–“: ${timestamp}`;

            // é¡¯ç¤ºè¼¸å…¥è®Šæ•¸
            displayInputVariables(data);
            
            // é¡¯ç¤ºæœå°‹è³‡è¨Š
            displaySearchInfo(data);
            
            // é¡¯ç¤º LOINC çµæœ
            displayLoincResults(data);
            
            // é¡¯ç¤º AI åˆ†æ
            displayAiAnalysis(data);
            
            // é¡¯ç¤ºå°è©±æ­·å²
            displayConversationHistory(data);
            
            // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
            displayMetadataInfo(data);
            
            // å•Ÿç”¨ Ask Stan æŒ‰éˆ•
            const askStanBtn = document.getElementById('askStanBtn');
            if (askStanBtn) {
                askStanBtn.disabled = false;
                askStanBtn.textContent = 'ğŸ¤– Ask Stan';
                askStanBtn.style.background = 'linear-gradient(135deg, #9c27b0, #ba68c8)';
            }
            
            // è‡ªå‹•å±•é–‹æª”æ¡ˆè³‡è¨Šå€åŸŸä»¥é¡¯ç¤ºå‚™è¨»åŠŸèƒ½
            const metadataSection = document.querySelector('[onclick*="metadataInfo"]');
            const metadataContent = document.getElementById('metadataInfo');
            if (metadataSection && metadataContent && !metadataContent.classList.contains('expanded')) {
                metadataContent.classList.add('expanded');
                metadataSection.classList.add('active');
                const expandIcon = metadataSection.querySelector('.expand-icon');
                if (expandIcon) expandIcon.classList.add('expanded');
            }
        }

        // é¡¯ç¤ºè¼¸å…¥è®Šæ•¸
        function displayInputVariables(data) {
            const container = document.getElementById('inputVariables');
            const labData = data.labDataContext;
            
            if (!labData || Object.keys(labData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æ­¤çµæœæ²’æœ‰å¯¦é©—å®¤æ•¸æ“šèƒŒæ™¯è³‡è¨Š</p>
                    </div>
                `;
                return;
            }

            const variableMap = {
                labItemName: 'æª¢æ¸¬é …ç›®åç¨±',
                labUnit: 'æ¸¬é‡å–®ä½',
                labSampleType: 'æª¢é«”é¡å‹',
                labTotalRecords: 'ç¸½è¨˜éŒ„æ•¸',
                labUniquePatients: 'ç¨ç‰¹æ‚£è€…æ•¸',
                labMissingValues: 'ç¼ºå¤±å€¼æ¯”ä¾‹',
                labMeanValue: 'å¹³å‡å€¼',
                labMedianValue: 'ä¸­ä½æ•¸',
                itemRank: 'é …ç›®æ’å',
                institution: 'é†«ç™‚æ©Ÿæ§‹',
                institutionType: 'æ©Ÿæ§‹é¡å‹',
                institutionLocation: 'æ©Ÿæ§‹ä½ç½®',
                itemId: 'é …ç›®è­˜åˆ¥ç¢¼',
                dataSource: 'è³‡æ–™ä¾†æº'
            };

            const variablesHtml = Object.entries(labData)
                .filter(([key, value]) => key !== 'timestamp' && key !== 'source' && value)
                .map(([key, value]) => `
                    <div class="variable-item">
                        <div class="variable-label">${variableMap[key] || key}</div>
                        <div class="variable-value">${value}</div>
                    </div>
                `).join('');

            container.innerHTML = `
                <div class="input-variables">
                    <h3>å¯¦é©—å®¤æ•¸æ“šèƒŒæ™¯è³‡è¨Š</h3>
                    <div class="variables-grid">
                        ${variablesHtml}
                    </div>
                </div>
            `;
        }

        // é¡¯ç¤ºæœå°‹è³‡è¨Š
        function displaySearchInfo(data) {
            const container = document.getElementById('searchInfo');
            const search = data.search || {};
            
            container.innerHTML = `
                <div class="search-info">
                    <h3>æœå°‹æ¢ä»¶è¨­å®š</h3>
                    <div class="search-terms">
                        <div class="search-term">
                            <div class="search-term-label">æœå°‹è©èª</div>
                            <div class="search-term-value">${search.searchTerms || 'æœªæŒ‡å®š'}</div>
                        </div>
                        <div class="search-term">
                            <div class="search-term-label">å¿…é ˆåŒ…å«è©èª</div>
                            <div class="search-term-value">${search.mustHaveTerms || 'æœªæŒ‡å®š'}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // é¡¯ç¤º LOINC çµæœ
        function displayLoincResults(data) {
            const container = document.getElementById('loincResults');
            const selectedDetails = data.selectedDetails || [];
            
            if (selectedDetails.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æ²’æœ‰é¸æ“‡çš„ LOINC ä»£ç¢¼</p>
                    </div>
                `;
                return;
            }

            const loincCardsHtml = selectedDetails.map(loinc => {
                // æ¸…ç† component ä¸­çš„ HTML æ¨™ç±¤
                const cleanComponent = loinc.component ? loinc.component.replace(/<[^>]*>/g, '').replace(/\s+/g, ' ').trim() : 'N/A';
                
                return `
                    <div class="loinc-card">
                        <div class="loinc-header">
                            <div class="loinc-code">${loinc.loincNum}</div>
                            ${loinc.similarityScore ? `<div class="similarity-score">${loinc.similarityScore}% ç›¸ä¼¼åº¦</div>` : ''}
                        </div>
                        <div class="loinc-details">
                            <div class="loinc-detail">
                                <div class="loinc-detail-label">å®Œæ•´åç¨±</div>
                                <div class="loinc-detail-value">${cleanComponent}</div>
                            </div>
                            <div class="loinc-detail">
                                <div class="loinc-detail-label">é•·åç¨±</div>
                                <div class="loinc-detail-value">${loinc.longCommonName || 'N/A'}</div>
                            </div>
                            <div class="loinc-detail">
                                <div class="loinc-detail-label">ç›¸é—œåç¨±</div>
                                <div class="loinc-detail-value">${loinc.relatedNames2 || 'N/A'}</div>
                            </div>
                            <div class="loinc-detail">
                                <div class="loinc-detail-label">å¸¸è¦‹æ¸¬è©¦æ’å</div>
                                <div class="loinc-detail-value">${loinc.commonTestRank || '0'}</div>
                            </div>
                            <div class="loinc-detail">
                                <div class="loinc-detail-label">å¸¸è¦‹è¨‚å–®æ’å</div>
                                <div class="loinc-detail-value">${loinc.commonOrderRank || '0'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="loinc-results">
                    <h3>é¸æ“‡çš„ LOINC ä»£ç¢¼è©³ç´°è³‡è¨Š (${selectedDetails.length} å€‹)</h3>
                    ${loincCardsHtml}
                </div>
            `;
        }

        // é¡¯ç¤º AI åˆ†æ
        function displayAiAnalysis(data) {
            const container = document.getElementById('aiAnalysis');
            const analysis = data.aiAnalysis;
            
            if (!analysis) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æ²’æœ‰ AI åˆ†æçµæœ</p>
                    </div>
                `;
                return;
            }

            // å°‡åˆ†æçµæœè½‰æ›ç‚º HTML
            const formattedAnalysis = analysis
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');

            container.innerHTML = `
                <div class="ai-analysis">
                    ${formattedAnalysis}
                </div>
            `;

            // ä¿®æ­£è¡¨æ ¼æ¨£å¼
            const tables = container.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.style.width) {
                    table.style.width = '100%';
                }
            });
        }

        // é¡¯ç¤ºå°è©±æ­·å²
        function displayConversationHistory(data) {
            const container = document.getElementById('conversationHistory');
            const historyHtml = data.conversationHistory;
            
            if (!historyHtml || historyHtml.trim() === '') {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>æ²’æœ‰ AI å°è©±æ­·å²</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="conversation-history">
                    <h3>AI å°è©±è¨˜éŒ„</h3>
                    ${historyHtml}
                </div>
            `;
        }

        // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
        function displayMetadataInfo(data) {
            const container = document.getElementById('metadataInfo');
            const metadata = data.metadata || {};
            
            const metadataItems = [
                { label: 'æª”æ¡ˆåç¨±', value: metadata.filename },
                { label: 'ç‰ˆæœ¬', value: metadata.version },
                { label: 'ä¾†æº', value: metadata.source },
                { label: 'å»ºç«‹æ™‚é–“', value: metadata.timestamp ? new Date(metadata.timestamp).toLocaleString('zh-TW') : 'N/A' },
                { label: 'é¸æ“‡ä»£ç¢¼æ•¸', value: data.selectedLoincCodes ? data.selectedLoincCodes.length : 0 }
            ].filter(item => item.value);

            const metadataHtml = metadataItems.map(item => `
                <div class="metadata-item">
                    <div class="metadata-label">${item.label}</div>
                    <div class="metadata-value">${item.value}</div>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="metadata-info">
                    <h3>æª”æ¡ˆè©³ç´°è³‡è¨Š</h3>
                    <div class="metadata-grid">
                        ${metadataHtml}
                    </div>
                    
                    <!-- æª”æ¡ˆå‚™è¨»å€åŸŸ -->
                    <div class="file-notes-section">
                        <div class="file-notes-header">
                            <label class="file-notes-label">ğŸ“ æª”æ¡ˆå‚™è¨»</label>
                            <span class="file-notes-toggle" onclick="toggleFileNotes()" title="å±•é–‹/æ”¶èµ·å‚™è¨»">
                                <span id="file-notes-icon">â–¼</span>
                            </span>
                        </div>
                        <div class="file-notes-content expanded" id="file-notes-content">
                            <textarea 
                                class="file-notes-textarea" 
                                id="file-notes-textarea"
                                placeholder="åœ¨æ­¤æ·»åŠ é—œæ–¼æ­¤ LOINC æ˜ å°„æª”æ¡ˆçš„å‚™è¨»ã€èªªæ˜æˆ–è§€å¯Ÿè¨˜éŒ„..."
                                onblur="saveFileNote(this.value)"
                                oninput="markFileNoteAsModified()"
                            >${data.fileNotes || ''}</textarea>
                            <div class="file-notes-footer">
                                <span class="file-notes-status" id="file-notes-status">
                                    ${(data.fileNotes && data.fileNotes.trim()) ? 'âœ… å·²ä¿å­˜' : 'ğŸ“ å¯æ·»åŠ å‚™è¨»'}
                                </span>
                                <span class="file-notes-timestamp" id="file-notes-timestamp">
                                    ${data.fileNotesTimestamp ? `æ›´æ–°æ–¼: ${new Date(data.fileNotesTimestamp).toLocaleString('zh-TW')}` : ''}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // åˆ‡æ›å€æ®µå±•é–‹/æ”¶åˆ
        function toggleSection(header, contentId) {
            const content = document.getElementById(contentId);
            const icon = header.querySelector('.expand-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('active');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                header.classList.add('active');
                icon.classList.add('expanded');
            }
        }

        // å°å‡ºåŠŸèƒ½
        function exportToJson() {
            if (!currentData) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æª”æ¡ˆ');
                return;
            }

            const dataStr = JSON.stringify(currentData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `loinc_mapping_export_${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function exportToPdf() {
            if (!currentData) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æª”æ¡ˆ');
                return;
            }
            
            window.print();
        }

        function printReport() {
            if (!currentData) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æª”æ¡ˆ');
                return;
            }
            
            window.print();
        }

        // Ask Stan åŠŸèƒ½
        async function askStan() {
            if (!currentData) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æª”æ¡ˆ');
                return;
            }
            
            const askStanBtn = document.getElementById('askStanBtn');
            const originalText = askStanBtn.textContent;
            askStanBtn.disabled = true;
            askStanBtn.textContent = 'æº–å‚™ä¸­...';
            
            try {
                // æº–å‚™è¦ç™¼é€çµ¦ Stan çš„è³‡æ–™
                const stanData = {
                    timestamp: new Date().toISOString(),
                    searchTerms: currentData.search?.searchTerms || '',
                    mustHaveTerms: currentData.search?.mustHaveTerms || '',
                    selectedLoincCodes: currentData.selectedLoincCodes || [],
                    selectedDetails: currentData.selectedDetails || [],
                    aiAnalysis: currentData.aiAnalysis || '',
                    conversationHistory: currentData.conversationHistory || '',
                    mappingNotes: currentData.fileNotes || '',
                    fileNotes: currentData.fileNotes || '',
                    labDataContext: currentData.labDataContext || null
                };
                
                console.log('Preparing to ask Stan:', {
                    selectedCount: stanData.selectedLoincCodes.length,
                    searchTerms: stanData.searchTerms,
                    hasAnalysis: !!stanData.aiAnalysis
                });
                
                // ç™¼é€åˆ°ä¼ºæœå™¨ä¸¦è¦æ±‚ç«‹å³ä¸‹è¼‰ PDF
                const baseUrl = window.location.protocol + '//' + window.location.host;
                const apiUrl = baseUrl + '/api/ask-stan?download=1';
                console.log('Making request to:', apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ...stanData, download: true })
                });

                console.log('Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type')
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/pdf')) {
                    const blob = await response.blob();
                    const disp = response.headers.get('content-disposition') || '';
                    const m = /filename=\"?([^\";]+)\"?/i.exec(disp);
                    const filename = m ? m[1] : `ask_stan_${Date.now()}.pdf`;
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    URL.revokeObjectURL(link.href);
                    askStanBtn.textContent = 'å·²ä¸‹è¼‰ PDF';
                    askStanBtn.style.background = '#7b1fa2';
                } else {
                    const result = await response.json();
                    if (result.success) {
                        alert(`å·²æˆåŠŸç™¼é€çµ¦ Stan ä¸¦ç”Ÿæˆ PDF å ±å‘Šï¼\n\nJSON æª”æ¡ˆ: ${result.jsonFilename}\nPDF æª”æ¡ˆ: ${result.pdfFilename || 'N/A'}`);
                        askStanBtn.textContent = 'å·²ç™¼é€';
                        askStanBtn.style.background = '#7b1fa2';
                    } else {
                        throw new Error(result.error || 'ç™¼é€å¤±æ•—');
                    }
                }
            } catch (error) {
                console.error('Ask Stan error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                alert('ç™¼é€çµ¦ Stan å¤±æ•—: ' + error.message);
                askStanBtn.textContent = originalText;
                askStanBtn.disabled = false;
            }
        }

        // ç¢ºèªåˆªé™¤æª”æ¡ˆ
        function confirmDeleteFile(filename) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤æª”æ¡ˆ "${filename}" å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                deleteFile(filename);
            }
        }
        
        // åˆªé™¤æª”æ¡ˆ
        async function deleteFile(filename) {
            try {
                const response = await fetch(`/api/delete-mapping-file/${filename}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    alert(`æª”æ¡ˆå·²æˆåŠŸåˆªé™¤ï¼\n\nåˆªé™¤çš„æª”æ¡ˆæ•¸: ${data.deletedCount}\n${data.deletedPaths ? data.deletedPaths.join('\n') : ''}`);
                    
                    // é‡æ–°è¼‰å…¥æª”æ¡ˆåˆ—è¡¨
                    await loadFileList();
                    
                    // å¦‚æœç•¶å‰é¡¯ç¤ºçš„æª”æ¡ˆè¢«åˆªé™¤ï¼Œéš±è—ä¸»å…§å®¹
                    if (currentData && currentData.metadata && currentData.metadata.filename === filename) {
                        document.getElementById('mainContent').classList.remove('show');
                        currentData = null;
                    }
                } else {
                    alert(`åˆªé™¤å¤±æ•—: ${data.error}\n${data.message || ''}`);
                }
            } catch (error) {
                console.error('åˆªé™¤æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert(`åˆªé™¤æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            }
        }

        // æª”æ¡ˆå‚™è¨»åŠŸèƒ½ç›¸é—œå‡½æ•¸
        let currentFileName = '';
        let fileNoteModified = false;

        // å±•é–‹/æ”¶èµ·æª”æ¡ˆå‚™è¨»å€åŸŸ
        function toggleFileNotes() {
            const content = document.getElementById('file-notes-content');
            const icon = document.getElementById('file-notes-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = 'â–¼';
            } else {
                content.classList.add('collapsed');
                icon.textContent = 'â–¶';
            }
        }

        // æ¨™è¨˜æª”æ¡ˆå‚™è¨»ç‚ºå·²ä¿®æ”¹
        function markFileNoteAsModified() {
            const textarea = document.getElementById('file-notes-textarea');
            const status = document.getElementById('file-notes-status');
            
            textarea.classList.add('modified');
            status.textContent = 'â³ ä¿®æ”¹ä¸­...';
            status.className = 'file-notes-status modified';
            
            fileNoteModified = true;
        }

        // ä¿å­˜æª”æ¡ˆå‚™è¨»
        async function saveFileNote(noteContent) {
            if (!currentFileName) {
                console.error('No file selected for saving file notes');
                return;
            }

            const textarea = document.getElementById('file-notes-textarea');
            const status = document.getElementById('file-notes-status');
            const timestamp = document.getElementById('file-notes-timestamp');
            
            try {
                // é¡¯ç¤ºä¿å­˜ç‹€æ…‹
                status.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
                status.className = 'file-notes-status';
                
                const response = await fetch('/api/save-file-note', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: currentFileName,
                        note: noteContent.trim(),
                        timestamp: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    textarea.classList.remove('modified');
                    status.textContent = noteContent.trim() ? 'âœ… å·²ä¿å­˜' : 'ğŸ“ å¯æ·»åŠ å‚™è¨»';
                    status.className = noteContent.trim() ? 'file-notes-status saved' : 'file-notes-status';
                    timestamp.textContent = `æ›´æ–°æ–¼: ${new Date().toLocaleString('zh-TW')}`;
                    fileNoteModified = false;
                } else {
                    throw new Error('ä¿å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Error saving file note:', error);
                status.textContent = 'âŒ ä¿å­˜å¤±æ•—';
                status.className = 'file-notes-status';
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­å®šé è¨­æª¢è¦–æ¨¡å¼
            document.getElementById('viewMode').value = 'table';
            loadFileList();
            // åˆå§‹åŒ–æ’åºåœ–ç¤º
            updateSortIcons('rank');
            // åˆå§‹åŒ–æª¢è¦–æ¨¡å¼
            changeViewMode();
        });
    </script>

    <style media="print">
        @media print {
            body {
                background: white !important;
            }
            
            .file-selector,
            .export-buttons {
                display: none !important;
            }
            
            .main-content {
                display: block !important;
                box-shadow: none !important;
                margin: 0 !important;
            }
            
            .section-content {
                max-height: none !important;
                padding: 20px 0 !important;
            }
            
            .section-header {
                cursor: default !important;
            }
            
            .expand-icon {
                display: none !important;
            }
        }
    </style>
</body>
</html>
