<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOINC Search</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .search-field {
            margin-bottom: 15px;
            position: relative;
        }
        .search-field-with-button {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .search-field-main {
            flex-grow: 1;
        }
        .translate-button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            height: 36px;
            margin-bottom: 10px;
        }
        .translate-button:hover {
            background-color: #3367d6;
        }
        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background-color: #f5f5f5;
        }
        .suggestion-summary {
            padding: 12px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 4px solid #2196f3;
            border-radius: 6px;
        }
        .suggestion-summary h4 {
            margin: 0 0 8px 0;
            color: #1976d2;
            font-size: 14px;
        }
        .suggestion-summary > div {
            margin: 4px 0;
            font-size: 13px;
            line-height: 1.4;
        }
        .suggestion-summary strong {
            color: #333;
        }
        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .suggestion-header h4 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        .close-suggestion-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .close-suggestion-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .results-header h3 {
            margin: 0;
            color: #495057;
            font-size: 18px;
            font-weight: 600;
        }
        .close-results-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .close-results-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-field label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-size: 14px;
        }
        .search-field input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-field input:focus {
            outline: none;
            border-color: #1a73e8;
        }
        .search-options {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .search-options label {
            margin-left: 8px;
            color: #666;
            font-size: 14px;
        }
        .filters-container {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        .filters-header {
            color: #333;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .search-options input[type="checkbox"] {
            transform: scale(1.2);
        }
        .search-options .recommended {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 5px;
        }
        .filter-note {
            font-style: italic;
            color: #666;
            font-size: 12px;
            margin-top: 8px;
            padding-left: 25px;
        }
        .search-buttons {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        button:hover {
            background: #1557b0;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #analyzeBtn {
            background-color: #34a853;
        }
        #analyzeBtn:hover {
            background-color: #2e8b57;
        }
        #analyzeBtn:disabled {
            background-color: #cccccc;
        }
        .result-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .loinc-code {
            font-weight: bold;
            color: #1a73e8;
        }
        .similarity-score {
            background: #e8f0fe;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #1a73e8;
        }
        .result-content {
            display: grid;
            grid-template-columns: 1fr 1.8fr 0.8fr 0.8fr 1fr;
            gap: 10px;
        }
        .result-field {
            margin-bottom: 8px;
        }
        .field-label {
            font-weight: bold;
            color: #666;
            font-size: 12px;
        }
        .field-value {
            color: #333;
            font-size: 14px;
            line-height: 1.4;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            color: #d9534f;
            padding: 15px;
            text-align: center;
        }
        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .rank-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .rank-good {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .rank-moderate {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        .rank-poor {
            background-color: #ffebee;
            color: #c62828;
        }
        .ai-analysis {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 16px;
        }
        
        /* Improve markdown-like formatting with more spacing */
        .ai-analysis h2 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 12px;
            margin-top: 40px;
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: bold;
        }
        
        .ai-analysis h3 {
            color: #34495e;
            margin-top: 32px;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
            padding-left: 8px;
            border-left: 4px solid #3498db;
        }
        
        .ai-analysis p {
            margin-bottom: 20px;
            text-align: justify;
        }
        
        .ai-analysis ul, .ai-analysis ol {
            margin-bottom: 24px;
            padding-left: 32px;
        }
        
        .ai-analysis li {
            margin-bottom: 12px;
            line-height: 1.7;
        }
        
        .ai-analysis strong {
            color: #2c3e50;
            font-weight: bold;
        }
        
        /* Add spacing between sections */
        .ai-analysis > * {
            margin-bottom: 16px;
        }
        
        /* Improve table spacing */
        .ai-analysis table {
            margin: 24px 0;
            border-collapse: collapse;
        }
        
        .ai-analysis table th,
        .ai-analysis table td {
            padding: 12px 8px;
            text-align: left;
        }
        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .ai-header h3 {
            margin: 0;
            color: #34a853;
            font-size: 18px;
        }
        .close-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }
        .close-btn:hover {
            color: #333;
            background: none;
        }
        .ai-content {
            line-height: 1.5;
        }
        .ai-explanation {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #34a853;
            margin-top: 10px;
            white-space: pre-wrap;
            line-height: 1.3;
        }
        .ai-explanation br {
            display: none;
        }
        .ai-explanation br + br {
            display: block;
            content: "";
            margin-top: 10px;
        }
        .ai-explanation table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
            border: 2px solid #34a853;
            background-color: white;
        }
        .ai-explanation th {
            background-color: #34a853;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        .ai-explanation td {
            padding: 10px;
            border: 1px solid #dee2e6;
            vertical-align: top;
        }
        .ai-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
            border: 2px solid #34a853;
            background-color: white;
        }
        .ai-th {
            background-color: #34a853;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            border: 1px solid #dee2e6;
        }
        .ai-td {
            padding: 10px;
            border: 1px solid #dee2e6;
            vertical-align: top;
        }
        .ai-tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .ai-tr:hover {
            background-color: #e9ecef;
        }
        .ai-explanation p {
            margin: 5px 0;
        }
        .ai-explanation pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            margin: 10px 0;
        }
        .ai-result p {
            margin: 5px 0;
        }
        .ai-conversation {
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .conversation-history {
            margin-bottom: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .user-message, .ai-message {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.7;
        }
        .user-message {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .ai-message {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .ai-loading {
            padding: 10px;
            font-style: italic;
            color: #666;
        }
        .ai-response {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #34a853;
            margin-top: 12px;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 16px;
        }
        .ai-response br {
            display: none;
        }
        .ai-response br + br {
            display: block;
            content: "";
            margin-top: 10px;
        }
        .user-message p, .ai-message p {
            margin: 5px 0;
        }
        .conversation-input {
            display: flex;
            gap: 10px;
        }
        .conversation-input textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .conversation-input button {
            padding: 8px 16px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .conversation-input button:hover {
            background: #1557b0;
        }
        .reset-button {
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .reset-button:hover {
            background-color: #d32f2f;
        }
        .translate-loading {
            display: none;
            margin-left: 5px;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        .exact-match {
            border: 2px solid #4CAF50;
            background-color: #f1f8e9;
        }
        .exact-match .result-header {
            background-color: #e8f5e9;
        }
        .exact-match .loinc-code {
            font-size: 16px;
            color: #2E7D32;
        }
        .exact-match .similarity-score {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        .mapping-controls {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        .mapping-controls.show {
            display: block;
        }
        .mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .mapping-header h3 {
            margin: 0;
            color: #1a73e8;
            font-size: 18px;
        }
        .mapping-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .ai-provider-selection {
            display: flex;
            gap: 15px;
            margin-right: 15px;
        }
        .provider-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
        }
        .provider-label input[type="radio"] {
            margin: 0;
        }
        .provider-label:hover {
            color: #1a73e8;
        }
        .ai-provider-section {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .ai-provider-section h3 {
            margin: 0 0 10px 0;
            color: #1a73e8;
            font-size: 16px;
        }
        .provider-description {
            margin: 10px 0 0 0;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        .mapping-btn {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .mapping-btn:hover {
            background-color: #f57c00;
        }
        .mapping-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .clear-selection-btn {
            background-color: #f44336;
        }
        .clear-selection-btn:hover {
            background-color: #d32f2f;
        }
        .result-item {
            position: relative;
        }
        .loinc-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
            transform: scale(1.2);
            cursor: pointer;
        }
        .result-item.selected {
            border: 2px solid #ff9800;
            background-color: #fff8e1;
        }
        .mapping-analysis {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            line-height: 1.8;
            font-size: 16px;
            display: none;
        }
        .mapping-analysis.show {
            display: block;
        }
        .mapping-analysis h2 {
            color: #2c3e50;
            border-bottom: 3px solid #ff9800;
            padding-bottom: 12px;
            margin-top: 0;
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: bold;
        }
        .mapping-analysis h3 {
            color: #34495e;
            margin-top: 32px;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
            padding-left: 8px;
            border-left: 4px solid #ff9800;
        }
        .mapping-analysis p {
            margin-bottom: 20px;
            text-align: justify;
        }
        .mapping-analysis ul, .mapping-analysis ol {
            margin-bottom: 24px;
            padding-left: 32px;
        }
        .mapping-analysis li {
            margin-bottom: 12px;
            line-height: 1.7;
        }
        .mapping-analysis strong {
            color: #2c3e50;
            font-weight: bold;
        }
        .mapping-analysis table {
            margin: 24px 0;
            border-collapse: collapse;
            width: 100%;
            border: 2px solid #ff9800;
            background-color: white;
        }
        
        /* Notes section styles */
        .notes-container {
            background: #fff8e1;
            border: 1px solid #ffcc02;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .mapping-notes-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .mapping-notes-textarea:focus {
            outline: none;
            border-color: #ff9800;
            box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
        }
        
        .notes-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .notes-status {
            font-weight: 500;
        }
        
        .notes-timestamp {
            color: #999;
        }
        .mapping-analysis table th,
        .mapping-analysis table td {
            padding: 12px 8px;
            text-align: left;
            border: 1px solid #dee2e6;
        }
        .mapping-analysis table th {
            background-color: #ff9800;
            color: white;
            font-weight: bold;
        }
        .mapping-analysis table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .mapping-analysis table tr:hover {
            background-color: #e9ecef;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }
        .popup-overlay.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .popup-window {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            width: 1000px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .popup-header {
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .popup-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        .popup-header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .save-mapping-btn {
            background-color: #34a853;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .save-mapping-btn:hover:not(:disabled) {
            background-color: #2e8b57;
        }
        .save-mapping-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .ask-stan-btn {
            background-color: #9c27b0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .ask-stan-btn:hover:not(:disabled) {
            background-color: #7b1fa2;
        }
        .ask-stan-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .popup-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        .popup-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .popup-content {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }
        .mapping-section {
            margin-bottom: 30px;
        }
        .mapping-section h3 {
            color: #1a73e8;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.2em;
        }
        .loinc-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .loinc-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .loinc-code {
            font-weight: bold;
            color: #1a73e8;
            font-size: 1.1em;
        }
        .loinc-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        .detail-label {
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .detail-value {
            color: #333;
            line-height: 1.4;
        }
        .ai-suggestions {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .ai-suggestions h4 {
            color: #2e7d32;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .search-terms-display {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .search-terms-display h4 {
            color: #1976d2;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .lab-data-display {
            background-color: #f3e5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #9c27b0;
        }
        .lab-data-display h4 {
            color: #7b1fa2;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .lab-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .lab-data-item {
            background-color: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #e1bee7;
            font-size: 14px;
        }
        .lab-data-item strong {
            color: #7b1fa2;
        }
        .conversation-display {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .conversation-display .user-message,
        .conversation-display .ai-message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
        }
        .conversation-display .user-message {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .conversation-display .ai-message {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .conversation-display .ai-response {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #34a853;
            margin-top: 10px;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div style="text-align:center;font-size:1.3em;font-weight:bold;margin-bottom:18px;color:#1a73e8;">
        Taiwan Top 100 LOINC Ëê¨ÈÅî‰∫∫
    </div>
    
    <!-- Hidden nav per request -->
    <div style="display:none">
        <a href="/results-viewer.html">Êü•ÁúãÂ∑≤ÂÑ≤Â≠òÁöÑÊò†Â∞ÑÁµêÊûú</a>
        <a href="/enhanced-search.html">ÈÄ≤ÈöéÊêúÂ∞ã‰ªãÈù¢</a>
    </div>
    <div class="search-container">
        <div class="search-field">
            <div class="search-field-with-button">
                <div class="search-field-main">
                    <label for="field1">Search Terms (space-separated):</label>
                    <input type="text" id="field1" placeholder="e.g., creatine serum plasma">
                </div>
                <button class="translate-button" onclick="translateInput()">Áµ¶ÊàëÊêúÂ∞ãÂêçÁ®±ÁöÑÂª∫Ë≠∞</button>
            </div>
            <span class="translate-loading" id="translateLoading">ËΩâÊèõ‰∏≠...</span>
            <div class="suggestion-list" id="suggestionList"></div>
        </div>
        
        <!-- Component and System fields -->
        <div class="component-system-fields" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
            <div class="search-field">
                <label for="componentField">üß¨ Component (specific analyte):</label>
                <input type="text" id="componentField" placeholder="e.g., Erythrocytes, Glucose, Creatinine">
                <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
                    ÊåáÂÆöÊ™¢Ê∏¨ÁöÑÁâπÂÆöÊàêÂàÜÊàñÂàÜÊûêÁâ©
                </small>
            </div>
            <div class="search-field">
                <label for="systemField">üß™ System (specimen type):</label>
                <input type="text" id="systemField" placeholder="e.g., Blood, Serum, Plasma, Urine">
                <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">
                    ÊåáÂÆöÊ™¢È´îÊàñÁ≥ªÁµ±È°ûÂûã
                </small>
            </div>
        </div>
        
        <div class="search-field">
            <label for="field2">Must Have Terms (space-separated):</label>
            <input type="text" id="field2" placeholder="e.g., serum creatine plasma">
        </div>
        <div class="filters-container">
            <div class="filters-header">Rank Filters <span class="recommended">Recommended</span></div>
            <div class="search-options">
                <input type="checkbox" id="orderRankFilter">
                <label for="orderRankFilter">Only show Common Order Rank ‚â§ 300 (hide rank 0)</label>
            </div>
            <div class="search-options">
                <input type="checkbox" id="testRankFilter" checked>
                <label for="testRankFilter">Only show Common Test Rank ‚â§ 3000 (hide rank 0)</label>
            </div>
            <div class="filter-note">
                Note: When both filters are disabled, search requires more specific terms
            </div>
        </div>
        <div class="search-buttons">
            <button onclick="search()">Search</button>
            <button id="analyzeBtn" onclick="analyze()" disabled>Ë´ãËê¨ÈÅî‰∫∫Ëß£ÈáãÊêúÂ∞ãÁµêÊûú</button>
            <button onclick="resetAll()" class="reset-button">Reset All</button>
            <span id="autoUpdateIndicator" style="margin-left: 15px; color: #28a745; font-size: 0.9em; display: none;">
                ‚ö° Auto-update enabled
            </span>
        </div>
    </div>
    <div id="aiAnalysis" class="ai-analysis" style="display: none;">
        <div class="ai-header">
            <h3>AI Mapping Suggestions</h3>
            <button class="close-btn" onclick="document.getElementById('aiAnalysis').style.display = 'none'">√ó</button>
        </div>
        <div id="aiContent" class="ai-content">
            <div class="loading">Analyzing results with AI...</div>
        </div>
        <div id="aiConversation" class="ai-conversation" style="display: none;">
            <div class="conversation-history" id="conversationHistory"></div>
            <div class="conversation-input">
                <textarea id="followupQuestion" placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂæåÁ∫åÂïèÈ°å..." rows="2"></textarea>
                <button id="askFollowupBtn" onclick="askFollowupQuestion()">ÈÄÅÂá∫ÂïèÈ°å</button>
            </div>
        </div>
    </div>
    
    <!-- AI Provider Selection - Always Visible -->
    <div class="ai-provider-section">
        <h3>AI Êèê‰æõËÄÖÈÅ∏Êìá</h3>
        <div class="ai-provider-selection">
            <label class="provider-label">
                <input type="radio" name="aiProvider" value="openai" checked>
                <span>GPT-4</span>
            </label>
            <label class="provider-label">
                <input type="radio" name="aiProvider" value="claude">
                <span>Claude</span>
            </label>
            <label class="provider-label">
                <input type="radio" name="aiProvider" value="grok">
                <span>Grok</span>
            </label>
        </div>
        <p class="provider-description">ÈÅ∏Êìá AI Êèê‰æõËÄÖÁî®ÊñºÁîüÊàêÊò†Â∞ÑÂàÜÊûêÂª∫Ë≠∞</p>
    </div>

    <div id="mappingControls" class="mapping-controls">
        <div class="mapping-header">
            <h3>LOINC ‰ª£Á¢ºÊò†Â∞ÑÈÅ∏Êìá</h3>
            <div class="mapping-actions">
                <button id="generateMappingBtn" class="mapping-btn" onclick="showMappingPopup()" disabled>
                    ÂÑ≤Â≠òÈÅ∏Êìá
                </button>
                <button class="clear-selection-btn" onclick="clearAllSelections()">Ê∏ÖÈô§ÈÅ∏Êìá</button>
            </div>
        </div>
        <div id="selectedCount">Â∑≤ÈÅ∏Êìá 0 ÂÄã LOINC ‰ª£Á¢º</div>
    </div>
    
    <div id="mappingAnalysis" class="mapping-analysis">
        <div class="ai-header">
            <h3>AI Êò†Â∞ÑÂàÜÊûêÁµêÊûú</h3>
            <button class="close-btn" onclick="document.getElementById('mappingAnalysis').style.display = 'none'">√ó</button>
        </div>
        <div id="mappingContent" class="ai-content">
            <div class="loading">ÁîüÊàêÊò†Â∞ÑÂàÜÊûê‰∏≠...</div>
        </div>
    </div>
    
    <div id="results"></div>

    <!-- Mapping Popup Window -->
    <div id="mappingPopup" class="popup-overlay">
        <div class="popup-window">
            <div class="popup-header">
                <h2>LOINC Êò†Â∞ÑÈÅ∏ÊìáÁµêÊûú</h2>
                <div id="saveMessage" class="save-message" style="display: none; background: #d4edda; color: #155724; padding: 8px 12px; border-radius: 4px; margin: 8px 0; font-size: 14px; border: 1px solid #c3e6cb;">
                    ‚úì Êò†Â∞ÑÁµêÊûúÂ∑≤ÊàêÂäüÂÑ≤Â≠òÔºÅ
                </div>
                <div class="popup-header-actions">
                    <button id="askStanBtn" class="ask-stan-btn" onclick="askStan()" disabled>
                        Ask Stan
                    </button>
                    <button id="saveMappingBtn" class="save-mapping-btn" onclick="saveMappingResults()" disabled>
                        ÂÑ≤Â≠òÊò†Â∞ÑÁµêÊûú
                    </button>
                    <button class="popup-close" onclick="closeMappingPopup()">√ó</button>
                </div>
            </div>
            <div class="popup-content" id="popupContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <footer style="text-align:center;color:#888;font-size:1em;margin-top:40px;margin-bottom:10px;">
        Áî±Âè∞ÁÅ£ÈÜ´Â≠∏Ë≥áË®äÂ≠∏ÊúÉ (TAMI) Á∂≠Ë≠∑ - ÊûóÊòéÈå¶ (Mark Lin)
    </footer>

    <script>
        let currentSearchResults = [];
        let currentAnalysis = "";
        let currentSearchTerms = "";
        let currentMustHaveTerms = "";
        let selectedLoincCodes = new Set();
        let currentMappingAnalysis = "";
        let mappingNotes = "";
        let notesModified = false;
        let notesSaved = false;
        
        // Function to get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            const value = urlParams.get(name);
            console.log(`getUrlParameter('${name}') =`, value);
            return value;
        }
        
        // Global variable to store lab data context
        let labDataContext = {};
        
        // Function to populate form from URL parameters
        function populateFormFromUrl() {
            console.log('populateFormFromUrl called');
            console.log('Current URL:', window.location.href);
            console.log('Search params:', window.location.search);
            console.log('Document ready state:', document.readyState);
            console.log('Form elements available:', {
                field1: !!document.getElementById('field1'),
                field2: !!document.getElementById('field2'),
                orderRankFilter: !!document.getElementById('orderRankFilter'),
                testRankFilter: !!document.getElementById('testRankFilter')
            });
            
            // Get all lab data parameters
            const labItemName = getUrlParameter('labItemName');
            const labUnit = getUrlParameter('labUnit');
            const labSampleType = getUrlParameter('labSampleType');
            const labTotalRecords = getUrlParameter('labTotalRecords');
            const labUniquePatients = getUrlParameter('labUniquePatients');
            const labMissingValues = getUrlParameter('labMissingValues');
            const labMeanValue = getUrlParameter('labMeanValue');
            const labMedianValue = getUrlParameter('labMedianValue');
            const itemRank = getUrlParameter('itemRank');
            const institution = getUrlParameter('institution');
            const institutionType = getUrlParameter('institutionType');
            const institutionLocation = getUrlParameter('institutionLocation');
            const itemId = getUrlParameter('itemId');
            const dataSource = getUrlParameter('dataSource');
            const timestamp = getUrlParameter('timestamp');
            
            // Standard parameters
            const searchTerms = getUrlParameter('searchTerms');
            const mustHaveTerms = getUrlParameter('mustHaveTerms');
            const rankFilter1 = getUrlParameter('rankFilter1');
            const rankFilter2 = getUrlParameter('rankFilter2');
            
            // Store lab data context globally for later use
            labDataContext = {
                labItemName,
                labUnit,
                labSampleType,
                labTotalRecords,
                labUniquePatients,
                labMissingValues,
                labMeanValue,
                labMedianValue,
                itemRank,
                institution,
                institutionType,
                institutionLocation,
                itemId,
                dataSource,
                timestamp,
                source: 'url_parameters'
            };
            
            console.log('Lab data context saved:', labDataContext);
            
            // If we have lab data, construct search terms automatically
            let autoSearchTerms = '';
            if (labItemName || labUnit || labSampleType) {
                autoSearchTerms = [labItemName, labUnit, labSampleType].filter(Boolean).join(' ');
                console.log('Auto-constructed search terms:', autoSearchTerms);
            }
            
            console.log('URL parameters:', { searchTerms, mustHaveTerms, rankFilter1, rankFilter2, autoSearchTerms });
            
            // Priority: explicit searchTerms > auto-constructed terms from lab data
            const finalSearchTerms = searchTerms || autoSearchTerms;
            
            if (finalSearchTerms) {
                // Use a safer decoding approach that handles malformed URIs
                let decodedTerms;
                try {
                    decodedTerms = decodeURIComponent(finalSearchTerms);
                } catch (e) {
                    console.log('decodeURIComponent failed, using raw value:', e.message);
                    decodedTerms = finalSearchTerms;
                }
                console.log('Setting field1 to:', decodedTerms);
                const field1Element = document.getElementById('field1');
                if (field1Element) {
                    field1Element.value = decodedTerms;
                    console.log('field1 value set to:', field1Element.value);
                } else {
                    console.error('field1 element not found!');
                }
            }
            
            if (mustHaveTerms) {
                // Use a safer decoding approach that handles malformed URIs
                let decodedMustHave;
                try {
                    decodedMustHave = decodeURIComponent(mustHaveTerms);
                } catch (e) {
                    console.log('decodeURIComponent failed, using raw value:', e.message);
                    decodedMustHave = mustHaveTerms;
                }
                console.log('Setting field2 to:', decodedMustHave);
                const field2Element = document.getElementById('field2');
                if (field2Element) {
                    field2Element.value = decodedMustHave;
                    console.log('field2 value set to:', field2Element.value);
                } else {
                    console.error('field2 element not found!');
                }
            }
            
            if (rankFilter1 !== null) {
                console.log('Setting orderRankFilter to:', rankFilter1 === 'true');
                document.getElementById('orderRankFilter').checked = rankFilter1 === 'true';
            }
            
            if (rankFilter2 !== null) {
                console.log('Setting testRankFilter to:', rankFilter2 === 'true');
                document.getElementById('testRankFilter').checked = rankFilter2 === 'true';
            }
        }
        
        // Initialize form with URL parameters when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');
            populateFormFromUrl();
        });
        
        // Also try to populate immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            console.log('Document still loading, waiting for DOMContentLoaded');
        } else {
            console.log('Document already loaded, populating immediately');
            populateFormFromUrl();
        }
        
        // Reset all fields and results
        function resetAll() {
            // Clear any pending auto-searches
            if (typeof searchTimeout !== 'undefined') {
                clearTimeout(searchTimeout);
            }

            // Clear input fields
            document.getElementById('field1').value = '';
            document.getElementById('field2').value = '';
            document.getElementById('componentField').value = '';
            document.getElementById('systemField').value = '';

            // Reset checkboxes to default (only testRankFilter checked)
            document.getElementById('orderRankFilter').checked = false;
            document.getElementById('testRankFilter').checked = true;
            
            // Clear suggestion list
            const suggestionList = document.getElementById('suggestionList');
            suggestionList.innerHTML = '';
            suggestionList.style.display = 'none';
            
            // Hide AI analysis
            document.getElementById('aiAnalysis').style.display = 'none';
            
            // Hide mapping controls and analysis
            document.getElementById('mappingControls').classList.remove('show');
            document.getElementById('mappingAnalysis').style.display = 'none';
            
            // Hide mapping popup
            document.getElementById('mappingPopup').classList.remove('show');
            
            // Clear results
            document.getElementById('results').innerHTML = '';
            
            // Clear conversation history
            document.getElementById('conversationHistory').innerHTML = '';
            
            // Clear followup question input
            document.getElementById('followupQuestion').value = '';
            
            // Reset global variables
            currentSearchResults = [];
            currentAnalysis = "";
            currentSearchTerms = "";
            currentMustHaveTerms = "";
            selectedLoincCodes.clear();
            currentMappingAnalysis = "";
            
            // Disable analyze button
            document.getElementById('analyzeBtn').disabled = true;
            
            // Update selection count
            updateSelectionCount();
            
            console.log('All fields and results have been reset');
        }
        
        // ËôïÁêÜÂñÆË§áÊï∏ËΩâÊèõ
        function normalizeTerm(term) {
            // ÁßªÈô§Â∞æÈÉ®ÁöÑ 's' Êàñ 'es'ÔºåÁî®ÊñºËôïÁêÜÁ∞°ÂñÆÁöÑËã±ÊñáÂñÆË§áÊï∏ÂΩ¢Âºè
            // ‰æãÂ¶Ç: LYMPHOCYTES -> LYMPHOCYTE, VIRUSES -> VIRUS
            if (term.endsWith('ies')) {
                return term.substring(0, term.length - 3) + 'y';
            } else if (term.endsWith('es')) {
                return term.substring(0, term.length - 2);
            } else if (term.endsWith('s') && !term.endsWith('ss')) {
                return term.substring(0, term.length - 1);
            }
            return term;
        }
        
        // Process search terms to handle compound terms like "HIV 1", "Hepatitis B", etc.
        function processSearchTerms(rawInput) {
            // Replace commas with spaces
            const rawText = rawInput.replace(/,/g, ' ');
            
            // Common patterns to treat as compound terms
            const patterns = [
                /HIV\s+[0-9]/gi,            // HIV 1, HIV 2
                /Hepatitis\s+[A-Z]/gi,      // Hepatitis A, Hepatitis B
                /Type\s+[0-9A-Z]/gi,        // Type 1, Type A
                /Grade\s+[0-9]/gi,          // Grade 1, Grade 2
                /Class\s+[0-9A-Z]/gi,       // Class 1, Class A
                /Group\s+[0-9A-Z]/gi,       // Group A, Group 1
                /Stage\s+[0-9A-Z]/gi,       // Stage 1, Stage IV
                /Phase\s+[0-9]/gi,          // Phase 1, Phase 2
                /Level\s+[0-9]/gi,          // Level 1, Level 2
                /Factor\s+[0-9A-Z]/gi       // Factor V, Factor 8
            ];
            
            // Find all compound terms
            let compoundTerms = [];
            patterns.forEach(pattern => {
                const matches = rawText.match(pattern);
                if (matches) {
                    compoundTerms = compoundTerms.concat(matches);
                }
            });
            
            // First split by compound terms to preserve them
            let processedText = rawText;
            compoundTerms.forEach((term, index) => {
                // Replace compound term with a placeholder
                processedText = processedText.replace(term, `__COMPOUND_${index}__`);
            });
            
            // Split into individual terms
            let terms = processedText.split(/\s+/).filter(term => term.length > 0);
            
            // Replace placeholders with compound terms
            terms = terms.map(term => {
                if (term.startsWith('__COMPOUND_')) {
                    const index = parseInt(term.match(/__COMPOUND_(\d+)__/)[1]);
                    return compoundTerms[index];
                }
                return term;
            });
            
            // Filter out single-character terms that aren't part of compound terms
            terms = terms.filter(term => term.length > 1 || compoundTerms.includes(term));
            
            return terms;
        }
        
        async function translateInput() {
            const userInput = document.getElementById('field1').value;
            
            if (!userInput || userInput.trim() === '') {
                alert('Ë´ãËº∏ÂÖ•Ë¶ÅËΩâÊèõÁöÑÂÖßÂÆπ');
                return;
            }
            
            document.getElementById('translateLoading').style.display = 'inline';
            
            try {
                // Prepare request payload with lab metadata if available
                const requestPayload = { 
                    userInput: userInput,
                    // Include lab data context for better AI analysis
                    labDataContext: labDataContext && Object.keys(labDataContext).length > 0 ? labDataContext : null
                };
                
                console.log('Sending translate request with lab context:', requestPayload);
                
                const response = await fetch('/api/translate-input', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestPayload)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    alert('Translation error: ' + data.error);
                } else {
                    // Handle the new structured response format
                    if (data.suggestions) {
                        // Fill in the component and system fields with suggestions
                        if (data.suggestions.component) {
                            const cleanComponent = removePunctuation(data.suggestions.component);
                            document.getElementById('componentField').value = cleanComponent;
                            // Auto-fill Must Have Terms with component
                            document.getElementById('field2').value = cleanComponent;
                        } else {
                            // Clear Must Have Terms field if no component
                            document.getElementById('field2').value = '';
                        }
                        
                        if (data.suggestions.system) {
                            const cleanSystem = removePunctuation(data.suggestions.system);
                            document.getElementById('systemField').value = cleanSystem;
                        }
                        if (data.suggestions.searchTerms) {
                            const cleanSearchTerms = removePunctuation(data.suggestions.searchTerms);
                            document.getElementById('field1').value = cleanSearchTerms;
                        }
                        
                        // Show the suggestions in a formatted way
                        const suggestionList = document.getElementById('suggestionList');
                        suggestionList.innerHTML = `
                            <div class="suggestion-summary">
                                <div class="suggestion-header">
                                    <h4>ü§ñ AI Âª∫Ë≠∞ÂàÜÊûêÔºö</h4>
                                    <button class="close-suggestion-btn" onclick="closeSuggestions()" title="ÈóúÈñâÂª∫Ë≠∞Ë¶ñÁ™ó">
                                        ‚úñ ÈóúÈñâ
                                    </button>
                                </div>
                                ${data.suggestions.component ? `<div><strong>üß¨ Component:</strong> ${data.suggestions.component}</div>` : ''}
                                ${data.suggestions.system ? `<div><strong>üß™ System:</strong> ${data.suggestions.system}</div>` : ''}
                                ${data.suggestions.searchTerms ? `<div><strong>üîç Search Terms:</strong> ${data.suggestions.searchTerms}</div>` : ''}
                                ${data.suggestions.explanation ? `<div style="margin-top: 8px; color: #666; font-size: 12px;"><strong>Ë™™Êòé:</strong> ${data.suggestions.explanation}</div>` : ''}
                            </div>
                        `;
                        suggestionList.style.display = 'block';
                        
                        // Hide suggestions after 15 seconds
                        setTimeout(() => {
                            suggestionList.style.display = 'none';
                        }, 15000);
                    } else {
                        // Fallback to old format for backward compatibility
                        const cleanResponse = removePunctuation(data.translatedTerms ? data.translatedTerms.join(' ') : data.response);
                        document.getElementById('field1').value = cleanResponse;
                        
                        // Show old format suggestions if available
                        if (data.translatedTerms && data.translatedTerms.length > 1) {
                            const suggestionList = document.getElementById('suggestionList');
                            suggestionList.innerHTML = '';
                            
                            data.translatedTerms.forEach(term => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.textContent = term;
                                div.onclick = function() {
                                    const cleanTerm = removePunctuation(term);
                                    document.getElementById('field1').value = cleanTerm;
                                    suggestionList.style.display = 'none';
                                };
                                suggestionList.appendChild(div);
                            });
                            
                            suggestionList.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Translation error:', error);
                alert('Translation failed: ' + error.message);
            } finally {
                document.getElementById('translateLoading').style.display = 'none';
            }
        }
        
        async function search() {
            // Áç≤Âèñ‰∏¶È†êËôïÁêÜËº∏ÂÖ•ÔºåÁßªÈô§ÈÄóËôü
            const rawField1 = document.getElementById('field1').value;
            const rawField2 = document.getElementById('field2').value;
            
            // Check if field1 is a LOINC code (format: numbers-numbers)
            const loincCodePattern = /^\d+-\d+$/;
            const isLoincCode = loincCodePattern.test(rawField1.trim());
            
            if (isLoincCode) {
                console.log(`Detected LOINC code: ${rawField1.trim()}`);
                // Áõ¥Êé•‰ΩøÁî® direct-loinc API ÈÄ≤Ë°åÊêúÁ¥¢
                const loincCode = rawField1.trim();
                
                // Ê∏ÖÈô§ÂÖàÂâçÁöÑÂàÜÊûê
                currentAnalysis = "";
                document.getElementById('analyzeBtn').disabled = true;
                
                // È°ØÁ§∫ÊêúÁ¥¢ÊåáÁ§∫Âô®
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '<div class="searching">Searching for LOINC code: ' + loincCode + '...</div>';
                
                try {
                    const response = await fetch('/api/direct-loinc', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ loincCode: loincCode })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.results || data.results.length === 0) {
                        resultsDiv.innerHTML = `<div class="no-results">No results found for LOINC code: ${loincCode}</div>`;
                        return;
                    }
                    
                    // ‰øùÂ≠òÊêúÁ¥¢Ë©û‰ª•‰æõÂæåÁ∫å AI ÂàÜÊûê‰ΩøÁî®
                    currentSearchTerms = loincCode;
                    currentMustHaveTerms = "";
                    
                    // Generate a unique session ID for direct LOINC searches
                    const directSessionId = 'direct-' + Date.now();
                    
                    // ‰øùÂ≠òÁµêÊûú‰ª•‰æõ AI ÂàÜÊûêÔºå‰∏¶Ê∑ªÂä† sessionId
                    currentSearchResults = data.results.map(result => ({
                        ...result,
                        sessionId: directSessionId // Add sessionId to each result
                    }));
                    
                    // ÂïüÁî®ÂàÜÊûêÊåâÈàï
                    document.getElementById('analyzeBtn').disabled = false;
                    
                    // È°ØÁ§∫ÁµêÊûú
                    displayResults(data.results);
                } catch (error) {
                    resultsDiv.innerHTML = '<div class="error">An error occurred while searching</div>';
                    console.error('Search error:', error);
                }
                return;
            }
            
            // Process search terms using the new function
            let field1Terms = processSearchTerms(rawField1);
            let field2Terms = processSearchTerms(rawField2);
            
            // Clear field2Terms if it contains placeholder text
            if (rawField2.includes('e.g.,') || rawField2.includes('serum creatine plasma')) {
                field2Terms = [];
                console.log('Cleared placeholder text from Must Have Terms');
            }
            
            // Check if we have valid search terms
            if (field1Terms.length === 0) {
                alert('Please provide search terms with at least 2 characters');
                return;
            }
            
            // Â¢ûÂº∑ÊêúÁ¥¢Ë©û‰ª•ÂåÖÂê´ÂèØËÉΩÁöÑÂñÆË§áÊï∏ÂΩ¢Âºè
            field1Terms = field1Terms.map(term => {
                // ËøîÂõûÂéüÂßãË©ûÂíåÊ®ôÊ∫ñÂåñË©û
                return normalizeTerm(term);
            });
            
            // Handle plurals for must-have terms
            field2Terms = field2Terms.map(term => {
                return normalizeTerm(term);
            });
            
            // Get component and system fields
            const componentField = document.getElementById('componentField').value.trim();
            const systemField = document.getElementById('systemField').value.trim();
            
            // Get filter checkboxes
            const orderRankFilter = document.getElementById('orderRankFilter').checked;
            const testRankFilter = document.getElementById('testRankFilter').checked;
            
            // Auto-add component to must-have terms if component is specified
            if (componentField) {
                console.log(`Before adding component - field2Terms:`, field2Terms);
                const componentTerms = processSearchTerms(componentField);
                console.log(`Component terms processed:`, componentTerms);
                const normalizedComponentTerms = componentTerms.map(term => normalizeTerm(term));
                console.log(`Normalized component terms:`, normalizedComponentTerms);
                
                // Add component terms to field2Terms if not already present
                normalizedComponentTerms.forEach(term => {
                    if (!field2Terms.some(existingTerm => 
                        existingTerm.toLowerCase() === term.toLowerCase())) {
                        field2Terms.push(term);
                        console.log(`Added term "${term}" to field2Terms`);
                    } else {
                        console.log(`Term "${term}" already exists in field2Terms`);
                    }
                });
                
                console.log(`After adding component - field2Terms:`, field2Terms);
                console.log(`Added component "${componentField}" to must-have terms`);
            }
            
            // ÈáçÊñ∞ÁµÑÂêàÊêúÁ¥¢Ë©û
            const field1 = field1Terms.join(' ');
            const field2 = field2Terms.join(' ');
            
            console.log(`Final field1: "${field1}"`);
            console.log(`Final field2 (with component): "${field2}"`);
            console.log(`Component field: "${componentField}"`);
            console.log(`System field: "${systemField}"`);
            
            // Log the complete search payload that will be sent to server
            const searchPayload = {
                field1: field1,
                field2: field2,
                componentField: componentField,
                systemField: systemField,
                useOrderRankFilter: orderRankFilter,
                useTestRankFilter: testRankFilter
            };
            console.log('Complete search payload:', searchPayload);
            
            // Check if both filters are off and search term is too generic
            if (!orderRankFilter && !testRankFilter && field1Terms.length < 2 && field1Terms[0].length < 4) {
                alert('With no filters applied, please use more specific search terms or apply rank filters');
                return;
            }
            
            // Save search terms for later use in AI analysis (including auto-added component)
            currentSearchTerms = rawField1;
            currentMustHaveTerms = field2; // Use the processed field2 which includes component
            
            // Clear previous analysis
            currentAnalysis = "";
            document.getElementById('analyzeBtn').disabled = true;
            
            // Show searching indicator
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="searching">Searching...</div>';
            
            try {
                // Include lab data context in the search request if available
                const searchPayload = {
                    field1: field1,
                    field2: field2,
                    componentField: componentField,
                    systemField: systemField,
                    useOrderRankFilter: orderRankFilter,
                    useTestRankFilter: testRankFilter
                };
                
                // Add lab data context if available
                if (labDataContext && Object.keys(labDataContext).length > 0) {
                    searchPayload.labDataContext = labDataContext;
                    console.log('Including lab data context in search:', labDataContext);
                }
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchPayload)
                });
                
                const data = await response.json();

                if (data.error) {
                    resultsDiv.innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }

                if (!data.results || data.results.length === 0) {
                    if (data.message) {
                        resultsDiv.innerHTML = `<div class="error" style="color:#d9534f;background:#fff3cd;border:1px solid #ffeeba;padding:16px;border-radius:8px;margin:20px 0;">${data.message}</div>`;
                    } else {
                        resultsDiv.innerHTML = '<div class="no-results">No results found</div>';
                    }
                    return;
                }

                // Â≠òÂÑ≤ÁµêÊûú‰ª•‰æõ AI ÂàÜÊûêÔºå‰∏¶Ê∑ªÂä† sessionId
                currentSearchResults = data.results.map(result => ({
                    ...result,
                    sessionId: data.sessionId // Add sessionId to each result
                }));
                
                // Â¶ÇÊûúÊúâÁµêÊûúÂâáÂïüÁî®ÂàÜÊûêÊåâÈàï
                document.getElementById('analyzeBtn').disabled = false;

                // È°ØÁ§∫ÁµêÊûú
                displayResults(data.results);
            } catch (error) {
                resultsDiv.innerHTML = '<div class="error">An error occurred while searching</div>';
                console.error('Search error:', error);
            }
        }

        async function analyze() {
            if (!currentSearchResults || currentSearchResults.length === 0) {
                alert('Please perform a search first');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.textContent = 'Analyzing...';

            try {
                // Get the sessionId from the first result or generate a fallback one if missing
                let sessionId = currentSearchResults[0]?.sessionId;
                
                // If sessionId is missing, generate a temporary one
                if (!sessionId) {
                    sessionId = 'temp-' + Date.now();
                    console.log('Using generated sessionId:', sessionId);
                    
                    // Add sessionId to all results to ensure consistency
                    currentSearchResults = currentSearchResults.map(result => ({
                        ...result,
                        sessionId: sessionId
                    }));
                }
                
                // Get selected AI provider
                const selectedProvider = document.querySelector('input[name="aiProvider"]:checked').value;
                
                const response = fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        results: currentSearchResults,
                        searchTerms: currentSearchTerms,
                        mustHaveTerms: currentMustHaveTerms,
                        provider: selectedProvider,
                        // Include lab data context for enhanced AI analysis
                        labDataContext: labDataContext && Object.keys(labDataContext).length > 0 ? labDataContext : null
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Store the analysis
                    currentAnalysis = data.summary;

                    // Â¶ÇÊûúÊúâÂª∫Ë≠∞ÁöÑ LOINC ‰ª£Á¢ºÔºåËá™ÂãïÈÅ∏‰∏≠
                    if (data.suggestedLoincCode) {
                        console.log('AI Âª∫Ë≠∞ÈÅ∏‰∏≠ LOINC ‰ª£Á¢º:', data.suggestedLoincCode);
                        
                        // Âª∂ÈÅ≤‰∏ÄÈªûÊôÇÈñìËÆì UI Êõ¥Êñ∞ÂÆåÊàê
                        setTimeout(() => {
                            if (typeof autoSelectSuggestedLoinc === 'function') {
                                autoSelectSuggestedLoinc(data.suggestedLoincCode);
                            } else {
                                console.warn('autoSelectSuggestedLoinc ÂáΩÊï∏Êú™ËºâÂÖ•');
                            }
                        }, 500);
                    }

                    // Display the analysis
                    const aiAnalysis = document.getElementById('aiAnalysis');
                    const aiContent = document.getElementById('aiContent');
                    
                    // Show the AI analysis section
                    aiAnalysis.style.display = 'block';
                    
                    // Update the content with proper table styling and line breaks
                    const formattedSummary = data.summary
                        .replace(/\n\n/g, '<br><br>')
                        .replace(/\n/g, '<br>');
                    
                    aiContent.innerHTML = `
                        <div class="ai-explanation">${formattedSummary}</div>
                    `;

                    // Apply table styling after adding to DOM
                    const tables = aiContent.querySelectorAll('table');
                    tables.forEach(table => {
                        if (!table.classList.contains('ai-table')) {
                            table.classList.add('ai-table');
                            if (!table.hasAttribute('border')) {
                                table.setAttribute('border', '1');
                            }
                            if (!table.hasAttribute('cellspacing')) {
                                table.setAttribute('cellspacing', '0');
                            }
                            if (!table.hasAttribute('cellpadding')) {
                                table.setAttribute('cellpadding', '8');
                            }
                        }
                        
                        // Add classes to table elements
                        table.querySelectorAll('tr').forEach(tr => {
                            tr.classList.add('ai-tr');
                        });
                        
                        table.querySelectorAll('th').forEach(th => {
                            th.classList.add('ai-th');
                        });
                        
                        table.querySelectorAll('td').forEach(td => {
                            td.classList.add('ai-td');
                        });
                    });

                    // Show the conversation section
                    document.getElementById('aiConversation').style.display = 'block';
                })
                .catch(error => {
                    console.error('Analysis error:', error);
                    alert('Error during analysis: ' + error.message);
                })
                .finally(() => {
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'Ë´ãËê¨ÈÅî‰∫∫Ëß£ÈáãÊêúÂ∞ãÁµêÊûú';
                });
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error during analysis: ' + error.message);
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Ë´ãËê¨ÈÅî‰∫∫Ëß£ÈáãÊêúÂ∞ãÁµêÊûú';
            }
        }

        async function askFollowupQuestion() {
            const question = document.getElementById('followupQuestion').value.trim();
            
            if (!question) {
                alert('Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÂïèÈ°å');
                return;
            }
            
            if (!currentSearchResults || currentSearchResults.length === 0) {
                alert('Please perform a search first');
                return;
            }
            
            // Add the question to the conversation history
            const historyDiv = document.getElementById('conversationHistory');
            historyDiv.innerHTML += `
                <div class="user-message">
                    <strong>ÊÇ®ÁöÑÂïèÈ°å:</strong>
                    <p>${question}</p>
                </div>
                <div class="ai-loading">AI Ê≠£Âú®ÂõûÁ≠î...</div>
            `;
            
            // Clear the question input
            document.getElementById('followupQuestion').value = '';
            
            // Scroll to the bottom of the conversation
            historyDiv.scrollTop = historyDiv.scrollHeight;
            
            try {
                // Get the sessionId from the first result or generate a fallback one if missing
                let sessionId = currentSearchResults[0]?.sessionId;
                
                // If sessionId is missing, generate a temporary one
                if (!sessionId) {
                    sessionId = 'temp-' + Date.now();
                    console.log('Using generated sessionId:', sessionId);
                    
                    // Add sessionId to all results to ensure consistency
                    currentSearchResults = currentSearchResults.map(result => ({
                        ...result,
                        sessionId: sessionId
                    }));
                }
                
                // Send the followup question
                const response = await fetch('/api/followup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sessionId: sessionId,
                        question: question,
                        results: currentSearchResults,
                        searchTerms: currentSearchTerms,
                        mustHaveTerms: currentMustHaveTerms
                    })
                });
                
                const data = await response.json();
                
                // Remove the loading message
                const loadingElem = historyDiv.querySelector('.ai-loading');
                if (loadingElem) {
                    loadingElem.remove();
                }
                
                if (data.error) {
                    historyDiv.innerHTML += `
                        <div class="ai-message error">
                            <p>${data.error}</p>
                        </div>
                    `;
                    return;
                }
                
                // Add the AI response to the conversation history with proper line breaks
                const formattedAnswer = data.answer
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
                
                historyDiv.innerHTML += `
                    <div class="ai-message">
                        <strong>AI ÂõûÁ≠î:</strong>
                        <div class="ai-response">${formattedAnswer}</div>
                    </div>
                `;
                
                // Apply table styling after adding to DOM
                const tables = historyDiv.querySelectorAll('.ai-message:last-child table');
                tables.forEach(table => {
                    if (!table.classList.contains('ai-table')) {
                        table.classList.add('ai-table');
                        if (!table.hasAttribute('border')) {
                            table.setAttribute('border', '1');
                        }
                        if (!table.hasAttribute('cellspacing')) {
                            table.setAttribute('cellspacing', '0');
                        }
                        if (!table.hasAttribute('cellpadding')) {
                            table.setAttribute('cellpadding', '8');
                        }
                    }
                    
                    // Ensure tbody exists
                    if (!table.querySelector('tbody') && table.querySelectorAll('tr').length > 0) {
                        const tbody = document.createElement('tbody');
                        const rows = Array.from(table.querySelectorAll('tr'));
                        // Only move rows that aren't in the header
                        const bodyRows = rows.slice(1);
                        bodyRows.forEach(row => {
                            tbody.appendChild(row);
                        });
                        table.appendChild(tbody);
                    }
                    
                    // Add classes to table elements
                    table.querySelectorAll('tr').forEach(tr => {
                        tr.classList.add('ai-tr');
                    });
                    
                    table.querySelectorAll('th').forEach(th => {
                        th.classList.add('ai-th');
                    });
                    
                    table.querySelectorAll('td').forEach(td => {
                        td.classList.add('ai-td');
                    });
                });
                
                // Scroll to the bottom of the conversation
                historyDiv.scrollTop = historyDiv.scrollHeight;
                
            } catch (error) {
                // Remove the loading message
                const loadingElem = historyDiv.querySelector('.ai-loading');
                if (loadingElem) {
                    loadingElem.remove();
                }
                
                historyDiv.innerHTML += `
                    <div class="ai-message error">
                        <p>ËôïÁêÜÊÇ®ÁöÑÂïèÈ°åÊôÇÁôºÁîüÈåØË™§: ${error.message}</p>
                    </div>
                `;
                console.error('Followup error:', error);
            }
        }

        function displayAIAnalysis(aiAnalysis) {
            if (!aiAnalysis) return;
            const aiExplanationDiv = document.getElementById('ai-explanation');
            
            // Set innerHTML directly to render HTML content
            aiExplanationDiv.innerHTML = aiAnalysis;
            
            // Ensure tables are displayed properly
            const tables = aiExplanationDiv.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.classList.contains('ai-table')) {
                    table.classList.add('ai-table');
                    table.setAttribute('border', '1');
                    table.setAttribute('cellspacing', '0');
                    table.setAttribute('cellpadding', '8');
                }
                
                // Ensure tbody exists
                if (!table.querySelector('tbody')) {
                    const tbody = document.createElement('tbody');
                    while (table.firstChild) {
                        tbody.appendChild(table.firstChild);
                    }
                    table.appendChild(tbody);
                }
                
                // Add classes to table elements
                table.querySelectorAll('tr').forEach(tr => {
                    tr.classList.add('ai-tr');
                });
                
                table.querySelectorAll('th').forEach(th => {
                    th.classList.add('ai-th');
                });
                
                table.querySelectorAll('td').forEach(td => {
                    td.classList.add('ai-td');
                });
            });
            
            document.getElementById('ai-section').style.display = 'block';
        }

        // Function to remove punctuation and replace with spaces
        function removePunctuation(text) {
            if (!text) return '';
            return text.replace(/[.,;:!?()[\]{}'"`~@#$%^&*+=|\\/<>-]/g, ' ').replace(/\s+/g, ' ').trim();
        }

        // Mapping-related functions
        function toggleLoincSelection(loincCode, checkbox) {
            if (checkbox.checked) {
                selectedLoincCodes.add(loincCode);
                checkbox.closest('.result-item').classList.add('selected');
            } else {
                selectedLoincCodes.delete(loincCode);
                checkbox.closest('.result-item').classList.remove('selected');
            }
            updateSelectionCount();
        }
        
        function updateSelectionCount() {
            const count = selectedLoincCodes.size;
            document.getElementById('selectedCount').textContent = `Â∑≤ÈÅ∏Êìá ${count} ÂÄã LOINC ‰ª£Á¢º`;
            
            const mappingControls = document.getElementById('mappingControls');
            const generateBtn = document.getElementById('generateMappingBtn');
            
            if (count > 0) {
                mappingControls.classList.add('show');
                generateBtn.disabled = false;
            } else {
                mappingControls.classList.remove('show');
                generateBtn.disabled = true;
            }
        }
        
        function clearAllSelections() {
            selectedLoincCodes.clear();
            
            // Uncheck all checkboxes and remove selected class
            document.querySelectorAll('.loinc-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.result-item').classList.remove('selected');
            });
            
            updateSelectionCount();
        }
        
        function showMappingPopup() {
            if (selectedLoincCodes.size === 0) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÊò†Â∞ÑÁöÑ LOINC ‰ª£Á¢º');
                return;
            }
            
            // Show popup
            const popup = document.getElementById('mappingPopup');
            const popupContent = document.getElementById('popupContent');
            const saveBtn = document.getElementById('saveMappingBtn');
            const askStanBtn = document.getElementById('askStanBtn');
            
            // Get selected AI provider
            const selectedProvider = document.querySelector('input[name="aiProvider"]:checked').value;
            
            // Get or generate sessionId
            let sessionId = currentSearchResults[0]?.sessionId;
            if (!sessionId) {
                sessionId = 'temp-' + Date.now();
                console.log('Using generated sessionId for mapping:', sessionId);
            }
            
            // Get selected LOINC details (needed for both success and error cases)
            const selectedDetails = currentSearchResults.filter(result => 
                selectedLoincCodes.has(result.loincNum)
            );
            
            // Show popup immediately without AI API calls
            popup.classList.add('show');
            
            // Use existing analysis or create a simple one
            const aiAnalysis = currentMappingAnalysis || currentAnalysis || 'No analysis available';
            const conversationHistoryHtml = document.getElementById('conversationHistory').innerHTML;
            
            // Enable buttons
            saveBtn.disabled = false;
            saveBtn.textContent = 'ÂÑ≤Â≠òÊò†Â∞ÑÁµêÊûú';
            saveBtn.style.backgroundColor = '#34a853';
            
            askStanBtn.disabled = false;
            askStanBtn.textContent = 'Ask Stan';
            askStanBtn.style.backgroundColor = '#9c27b0';
            
            // Display the popup content
            displayMappingPopupContent(selectedDetails, aiAnalysis, conversationHistoryHtml);
        }
        
        function displayMappingPopupContent(selectedDetails, aiAnalysis, conversationHistoryHtml) {
            const popupContent = document.getElementById('popupContent');
            
            // Create lab data context display
            let labDataHtml = '';
            if (labDataContext && Object.keys(labDataContext).length > 0) {
                labDataHtml = `
                    <div class="lab-data-display">
                        <h4>ÂØ¶È©óÂÆ§Êï∏ÊìöËÉåÊôØË≥áË®ä</h4>
                        <div class="lab-data-grid">
                            ${labDataContext.labItemName ? `<div class="lab-data-item"><strong>Ê™¢Ê∏¨È†ÖÁõÆÔºö</strong>${labDataContext.labItemName}</div>` : ''}
                            ${labDataContext.labUnit ? `<div class="lab-data-item"><strong>ÂñÆ‰ΩçÔºö</strong>${labDataContext.labUnit}</div>` : ''}
                            ${labDataContext.labSampleType ? `<div class="lab-data-item"><strong>Ê™¢È´îÈ°ûÂûãÔºö</strong>${labDataContext.labSampleType}</div>` : ''}
                            ${labDataContext.labTotalRecords ? `<div class="lab-data-item"><strong>Á∏ΩË®òÈåÑÊï∏Ôºö</strong>${labDataContext.labTotalRecords}</div>` : ''}
                            ${labDataContext.labUniquePatients ? `<div class="lab-data-item"><strong>Áç®ÁâπÊÇ£ËÄÖÊï∏Ôºö</strong>${labDataContext.labUniquePatients}</div>` : ''}
                            ${labDataContext.labMeanValue ? `<div class="lab-data-item"><strong>Âπ≥ÂùáÂÄºÔºö</strong>${labDataContext.labMeanValue}</div>` : ''}
                            ${labDataContext.labMedianValue ? `<div class="lab-data-item"><strong>‰∏≠‰ΩçÊï∏Ôºö</strong>${labDataContext.labMedianValue}</div>` : ''}
                            ${labDataContext.labMissingValues ? `<div class="lab-data-item"><strong>Áº∫Â§±ÂÄºÊØî‰æãÔºö</strong>${labDataContext.labMissingValues}</div>` : ''}
                            ${labDataContext.institution ? `<div class="lab-data-item"><strong>Ê©üÊßãÔºö</strong>${labDataContext.institution}</div>` : ''}
                            ${labDataContext.institutionType ? `<div class="lab-data-item"><strong>Ê©üÊßãÈ°ûÂûãÔºö</strong>${labDataContext.institutionType}</div>` : ''}
                            ${labDataContext.institutionLocation ? `<div class="lab-data-item"><strong>‰ΩçÁΩÆÔºö</strong>${labDataContext.institutionLocation}</div>` : ''}
                            ${labDataContext.itemId ? `<div class="lab-data-item"><strong>È†ÖÁõÆIDÔºö</strong>${labDataContext.itemId}</div>` : ''}
                            ${labDataContext.itemRank ? `<div class="lab-data-item"><strong>È†ÖÁõÆÊéíÂêçÔºö</strong>${labDataContext.itemRank}</div>` : ''}
                            ${labDataContext.dataSource ? `<div class="lab-data-item"><strong>Ë≥áÊñô‰æÜÊ∫êÔºö</strong>${labDataContext.dataSource}</div>` : ''}
                            ${labDataContext.timestamp ? `<div class="lab-data-item"><strong>ÊôÇÈñìÊà≥Ë®òÔºö</strong>${new Date(labDataContext.timestamp).toLocaleString('zh-TW')}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Create search terms display
            const searchTermsHtml = `
                <div class="search-terms-display">
                    <h4>ÂéüÂßãÊêúÂ∞ãÊü•Ë©¢</h4>
                    <p><strong>ÊêúÂ∞ãË©ûË™ûÔºö</strong>${currentSearchTerms || 'ÁÑ°'}</p>
                    <p><strong>ÂøÖÈ†àÂåÖÂê´Ë©ûË™ûÔºö</strong>${currentMustHaveTerms || 'ÁÑ°'}</p>
                </div>
            `;
            
            // Create LOINC details display
            const loincDetailsHtml = selectedDetails.map(item => {
                // Extract clean component name (remove HTML formatting)
                const cleanComponent = item.component.replace(/<[^>]*>/g, '').split(' | ')[0];
                
                return `
                    <div class="loinc-item">
                        <div class="loinc-item-header">
                            <span class="loinc-code">${item.loincNum}</span>
                        </div>
                        <div class="loinc-details">
                            <div class="detail-item">
                                <div class="detail-label">Full Name</div>
                                <div class="detail-value">${cleanComponent}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Related Names</div>
                                <div class="detail-value">${item.relatedNames2 || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Common Test Rank</div>
                                <div class="detail-value">${item.commonTestRank || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Common Order Rank</div>
                                <div class="detail-value">${item.commonOrderRank || 'N/A'}</div>
                            </div>
                            <div class="detail-item" style="grid-column: 1 / -1;">
                                <div class="detail-label">Long Common Name</div>
                                <div class="detail-value">${item.longCommonName || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Create AI suggestions display
            const formattedAnalysis = aiAnalysis
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
            
            const aiSuggestionsHtml = `
                <div class="ai-suggestions">
                    <h4>AI Êò†Â∞ÑÂª∫Ë≠∞</h4>
                    <div class="ai-explanation">${formattedAnalysis}</div>
                </div>
            `;
            
            // Create conversation history display
            const conversationHtml = conversationHistoryHtml ? `
                <div class="mapping-section">
                    <h3>AI Â∞çË©±Ê≠∑Âè≤</h3>
                    <div class="conversation-display">
                        ${conversationHistoryHtml}
                    </div>
                </div>
            ` : '';
            
            // Create notes section
            const notesHtml = `
                <div class="mapping-section">
                    <h3>üìù Êò†Â∞ÑÂÇôË®ª</h3>
                    <div class="notes-container">
                        <textarea 
                            id="mappingNotes" 
                            class="mapping-notes-textarea"
                            placeholder="Âú®Ê≠§Ê∑ªÂä†ÈóúÊñºÊ≠§ LOINC Êò†Â∞ÑÁöÑÂÇôË®ª„ÄÅË™™ÊòéÊàñËßÄÂØüË®òÈåÑ..."
                            rows="4"
                        ></textarea>
                        <div class="notes-footer">
                            <span class="notes-status" id="notes-status">üìù ÂèØÊ∑ªÂä†ÂÇôË®ª</span>
                            <span class="notes-timestamp" id="notes-timestamp"></span>
                        </div>
                    </div>
                </div>
            `;
            
            // Combine all content
            popupContent.innerHTML = `
                ${labDataHtml}
                <div class="mapping-section">
                    <h3>ÈÅ∏ÊìáÁöÑ LOINC ‰ª£Á¢ºË©≥Á¥∞Ë≥áË®ä</h3>
                    ${loincDetailsHtml}
                </div>
                ${aiSuggestionsHtml}
                ${conversationHtml}
                ${notesHtml}
            `;
            
            // Add search terms at the top
            popupContent.insertAdjacentHTML('afterbegin', searchTermsHtml);
            
            // Initialize notes functionality after DOM is updated
            setTimeout(() => {
                initializeNotesFunctionality();
            }, 10);
            
            // Apply table styling if any tables exist
            const tables = popupContent.querySelectorAll('table');
            tables.forEach(table => {
                if (!table.classList.contains('ai-table')) {
                    table.classList.add('ai-table');
                    if (!table.hasAttribute('border')) {
                        table.setAttribute('border', '1');
                    }
                    if (!table.hasAttribute('cellspacing')) {
                        table.setAttribute('cellspacing', '0');
                    }
                    if (!table.hasAttribute('cellpadding')) {
                        table.setAttribute('cellpadding', '8');
                    }
                }
                
                // Add classes to table elements
                table.querySelectorAll('tr').forEach(tr => {
                    tr.classList.add('ai-tr');
                });
                
                table.querySelectorAll('th').forEach(th => {
                    th.classList.add('ai-th');
                });
                
                table.querySelectorAll('td').forEach(td => {
                    td.classList.add('ai-td');
                });
            });
        }
        
        // Initialize notes functionality
        function initializeNotesFunctionality() {
            const notesTextarea = document.getElementById('mappingNotes');
            const notesStatus = document.getElementById('notes-status');
            const notesTimestamp = document.getElementById('notes-timestamp');
            
            console.log('initializeNotesFunctionality called', {
                textareaFound: !!notesTextarea,
                statusFound: !!notesStatus,
                timestampFound: !!notesTimestamp
            });
            
            if (notesTextarea) {
                // Only reset notes state if this is a new mapping (no existing notes)
                if (!mappingNotes) {
                    notesSaved = false;
                    notesModified = false;
                    mappingNotes = ''; // Clear previous notes
                    
                    console.log('Notes state reset for new mapping:', {
                        notesSaved: notesSaved,
                        notesModified: notesModified,
                        mappingNotes: mappingNotes
                    });
                } else {
                    console.log('Preserving existing notes:', {
                        mappingNotes: mappingNotes,
                        notesSaved: notesSaved,
                        notesModified: notesModified
                    });
                }
                
                // Load existing notes
                notesTextarea.value = mappingNotes;
                updateNotesStatus();
                
                // Remove existing event listeners to avoid duplicates
                const newTextarea = notesTextarea.cloneNode(true);
                notesTextarea.parentNode.replaceChild(newTextarea, notesTextarea);
                
                // Add event listeners to the new element
                newTextarea.addEventListener('input', function() {
                    mappingNotes = this.value;
                    notesModified = true;
                    notesSaved = false; // Reset saved status when content changes
                    updateNotesStatus();
                });
                
                newTextarea.addEventListener('blur', function() {
                    if (notesModified) {
                        updateNotesTimestamp();
                        notesModified = false;
                    }
                });
                
                console.log('Notes functionality initialized successfully');
            } else {
                console.error('mappingNotes textarea not found!');
            }
        }
        
        // Update notes status display
        function updateNotesStatus() {
            const notesStatus = document.getElementById('notes-status');
            if (notesStatus) {
                console.log('updateNotesStatus called:', {
                    notesSaved: notesSaved,
                    mappingNotes: mappingNotes,
                    hasContent: mappingNotes && mappingNotes.trim()
                });
                
                if (notesSaved && mappingNotes && mappingNotes.trim()) {
                    notesStatus.textContent = '‚úÖ Â∑≤‰øùÂ≠òÂÇôË®ª';
                    notesStatus.style.color = '#4caf50';
                } else if (mappingNotes && mappingNotes.trim()) {
                    notesStatus.textContent = 'üìù ÊúâÊú™‰øùÂ≠òÁöÑÂÇôË®ª';
                    notesStatus.style.color = '#ff9800';
                } else {
                    notesStatus.textContent = 'üìù ÂèØÊ∑ªÂä†ÂÇôË®ª';
                    notesStatus.style.color = '#666';
                }
            }
        }
        
        // Update notes timestamp
        function updateNotesTimestamp() {
            const notesTimestamp = document.getElementById('notes-timestamp');
            if (notesTimestamp) {
                notesTimestamp.textContent = `Êõ¥Êñ∞Êñº: ${new Date().toLocaleString('zh-TW')}`;
            }
        }
        
        function closeMappingPopup() {
            const popup = document.getElementById('mappingPopup');
            popup.classList.remove('show');
        }
        
        async function saveMappingResults() {
            if (selectedLoincCodes.size === 0) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÂÑ≤Â≠òÁöÑ LOINC ‰ª£Á¢º');
                return;
            }
            
            const saveBtn = document.getElementById('saveMappingBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'ÂÑ≤Â≠ò‰∏≠...';
            
            try {
                // Get selected LOINC details
                const selectedDetails = currentSearchResults.filter(result => 
                    selectedLoincCodes.has(result.loincNum)
                );
                
                // Get current notes from textarea
                const notesTextarea = document.getElementById('mappingNotes');
                const currentNotes = notesTextarea ? notesTextarea.value : mappingNotes;
                
                // Prepare the data to save
                const mappingData = {
                    timestamp: new Date().toISOString(),
                    searchTerms: currentSearchTerms,
                    mustHaveTerms: currentMustHaveTerms,
                    selectedLoincCodes: Array.from(selectedLoincCodes),
                    selectedDetails: selectedDetails,
                    aiAnalysis: currentMappingAnalysis || currentAnalysis, // Use mapping analysis if available, fallback to old analysis
                    conversationHistory: document.getElementById('conversationHistory').innerHTML,
                    // Include notes
                    mappingNotes: currentNotes || '',
                    notesTimestamp: currentNotes ? new Date().toISOString() : null,
                    // Include lab data context if available
                    labDataContext: labDataContext && Object.keys(labDataContext).length > 0 ? labDataContext : null
                };
                
                console.log('Preparing to save mapping data:', {
                    selectedCount: mappingData.selectedLoincCodes.length,
                    searchTerms: mappingData.searchTerms,
                    hasAnalysis: !!mappingData.aiAnalysis,
                    currentMappingAnalysis: currentMappingAnalysis ? 'Present' : 'Empty',
                    currentAnalysis: currentAnalysis ? 'Present' : 'Empty',
                    aiAnalysisLength: mappingData.aiAnalysis ? mappingData.aiAnalysis.length : 0,
                    conversationHistoryLength: mappingData.conversationHistory ? mappingData.conversationHistory.length : 0,
                    mappingNotesLength: mappingData.mappingNotes ? mappingData.mappingNotes.length : 0
                });
                
                // Performance timing
                const startTime = performance.now();
                console.log('Starting save operation at:', startTime);
                
                // Send to server to save
                // Construct the API URL properly, ignoring any query parameters
                const baseUrl = window.location.protocol + '//' + window.location.host;
                const apiUrl = baseUrl + '/api/save-mapping';
                console.log('Making request to:', apiUrl);
                console.log('Current location:', window.location.href);
                console.log('Base URL:', baseUrl);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mappingData)
                });
                
                const fetchTime = performance.now();
                console.log('Fetch completed at:', fetchTime, 'Duration:', (fetchTime - startTime).toFixed(2), 'ms');
                
                console.log('Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type')
                });
                
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response');
                }
                
                const result = await response.json();
                
                const parseTime = performance.now();
                console.log('JSON parsing completed at:', parseTime, 'Duration:', (parseTime - fetchTime).toFixed(2), 'ms');
                console.log('Total save operation time:', (parseTime - startTime).toFixed(2), 'ms');
                
                if (result.success) {
                    // Show inline success message instead of alert
                    const saveMessage = document.getElementById('saveMessage');
                    saveMessage.style.display = 'block';
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        saveMessage.style.display = 'none';
                    }, 3000);
                    
                    saveBtn.textContent = 'Â∑≤ÂÑ≤Â≠ò';
                    saveBtn.style.backgroundColor = '#2e8b57';
                    
                    // Mark notes as saved
                    notesSaved = true;
                    updateNotesStatus();
                } else {
                    throw new Error(result.error || 'ÂÑ≤Â≠òÂ§±Êïó');
                }
            } catch (error) {
                console.error('Save error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // Show inline error message instead of alert
                const saveMessage = document.getElementById('saveMessage');
                saveMessage.textContent = '‚úó ÂÑ≤Â≠òÂ§±Êïó: ' + error.message;
                saveMessage.style.background = '#f8d7da';
                saveMessage.style.color = '#721c24';
                saveMessage.style.border = '1px solid #f5c6cb';
                saveMessage.style.display = 'block';
                
                // Hide message after 5 seconds
                setTimeout(() => {
                    saveMessage.style.display = 'none';
                    // Reset to success message style
                    saveMessage.textContent = '‚úì Êò†Â∞ÑÁµêÊûúÂ∑≤ÊàêÂäüÂÑ≤Â≠òÔºÅ';
                    saveMessage.style.background = '#d4edda';
                    saveMessage.style.color = '#155724';
                    saveMessage.style.border = '1px solid #c3e6cb';
                }, 5000);
                
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }
        
        async function askStan() {
            if (selectedLoincCodes.size === 0) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅË©¢Âïè Stan ÁöÑ LOINC ‰ª£Á¢º');
                return;
            }
            
            const askStanBtn = document.getElementById('askStanBtn');
            const originalText = askStanBtn.textContent;
            askStanBtn.disabled = true;
            askStanBtn.textContent = 'Ê∫ñÂÇô‰∏≠...';
            
            try {
                // Get selected LOINC details
                const selectedDetails = currentSearchResults.filter(result => 
                    selectedLoincCodes.has(result.loincNum)
                );
                
                // Get current notes from textarea
                const notesTextarea = document.getElementById('mappingNotes');
                const currentNotes = notesTextarea ? notesTextarea.value : mappingNotes;
                
                // Prepare the data for Stan
                const stanData = {
                    timestamp: new Date().toISOString(),
                    searchTerms: currentSearchTerms,
                    mustHaveTerms: currentMustHaveTerms,
                    selectedLoincCodes: Array.from(selectedLoincCodes),
                    selectedDetails: selectedDetails,
                    aiAnalysis: currentMappingAnalysis || currentAnalysis, // Use mapping analysis if available, fallback to old analysis
                    conversationHistory: document.getElementById('conversationHistory').innerHTML,
                    mappingNotes: currentNotes || '',
                    labDataContext: labDataContext && Object.keys(labDataContext).length > 0 ? labDataContext : null
                };
                
                console.log('Preparing to ask Stan:', {
                    selectedCount: stanData.selectedLoincCodes.length,
                    searchTerms: stanData.searchTerms,
                    hasAnalysis: !!stanData.aiAnalysis
                });
                
                // Send to server to process and request immediate PDF download
                const baseUrl = window.location.protocol + '//' + window.location.host;
                const apiUrl = baseUrl + '/api/ask-stan?download=1';
                console.log('Making request to:', apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ...stanData, download: true })
                });

                console.log('Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: response.headers.get('content-type')
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentType = response.headers.get('content-type') || '';
                if (contentType.includes('application/pdf')) {
                    // Auto download the PDF
                    const blob = await response.blob();
                    const disp = response.headers.get('content-disposition') || '';
                    const m = /filename=\"?([^\";]+)\"?/i.exec(disp);
                    const filename = m ? m[1] : `ask_stan_${Date.now()}.pdf`;
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    URL.revokeObjectURL(link.href);
                    askStanBtn.textContent = 'Â∑≤‰∏ãËºâ PDF';
                    askStanBtn.style.backgroundColor = '#7b1fa2';
                } else {
                    // Fallback JSON handling
                    const result = await response.json();
                    if (result.success) {
                        alert(`Â∑≤ÊàêÂäüÁôºÈÄÅÁµ¶ Stan ‰∏¶ÁîüÊàê PDF Â†±ÂëäÔºÅ\n\nJSON Ê™îÊ°à: ${result.jsonFilename}\nPDF Ê™îÊ°à: ${result.pdfFilename || 'N/A'}`);
                        askStanBtn.textContent = 'Â∑≤ÁôºÈÄÅ';
                        askStanBtn.style.backgroundColor = '#7b1fa2';
                    } else {
                        throw new Error(result.error || 'ÁôºÈÄÅÂ§±Êïó');
                    }
                }
            } catch (error) {
                console.error('Ask Stan error:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                alert('ÁôºÈÄÅÁµ¶ Stan Â§±Êïó: ' + error.message);
                askStanBtn.textContent = originalText;
                askStanBtn.disabled = false;
            }
        }
        
        // Close popup when clicking outside
        document.getElementById('mappingPopup').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMappingPopup();
            }
        });

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            
            // Add close button at the top of results
            let closeButtonHtml = `
                <div class="results-header">
                    <h3>ÊêúÂ∞ãÁµêÊûú (${results.length} È†Ö)</h3>
                    <button class="close-results-btn" onclick="closeResults()" title="ÈóúÈñâÊêúÂ∞ãÁµêÊûú">
                        ‚úñ ÈóúÈñâÁµêÊûú
                    </button>
                </div>
            `;
            
            const resultsHtml = results.map(item => {
                // Format order rank with color tags
                let orderRankDisplay = '';
                const orderRank = parseInt(item.commonOrderRank);
                if (orderRank > 0 && orderRank <= 100) {
                    orderRankDisplay = `<span class="rank-badge rank-good">${orderRank}</span>`;
                } else if (orderRank > 100 && orderRank <= 300) {
                    orderRankDisplay = `<span class="rank-badge rank-moderate">${orderRank}</span>`;
                } else if (orderRank > 300) {
                    orderRankDisplay = `<span class="rank-badge rank-poor">${orderRank}</span>`;
                } else {
                    orderRankDisplay = '0';
                }
                
                // Format test rank with color tags
                let testRankDisplay = '';
                const testRank = parseInt(item.commonTestRank);
                if (testRank > 0 && testRank <= 1000) {
                    testRankDisplay = `<span class="rank-badge rank-good">${testRank}</span>`;
                } else if (testRank > 1000 && testRank <= 3000) {
                    testRankDisplay = `<span class="rank-badge rank-moderate">${testRank}</span>`;
                } else if (testRank > 3000) {
                    testRankDisplay = `<span class="rank-badge rank-poor">${testRank}</span>`;
                } else {
                    testRankDisplay = '0';
                }
                
                return `
                <div class="result-item">
                    <input type="checkbox" class="loinc-checkbox" 
                           value="${item.loincNum}"
                           onchange="toggleLoincSelection('${item.loincNum}', this)"
                           title="ÈÅ∏ÊìáÊ≠§ LOINC ‰ª£Á¢ºÈÄ≤Ë°åÊò†Â∞Ñ">
                    <div class="result-header">
                        <span class="loinc-code">${item.loincNum}</span>
                        <span class="similarity-score">${item.similarityScore.toFixed(2)}% match</span>
                    </div>
                    <div class="result-content">
                        <div class="result-field">
                            <div class="field-label">Full Name</div>
                            <div class="field-value">${item.component}</div>
                        </div>
                        <div class="result-field">
                            <div class="field-label">Related Names</div>
                            <div class="field-value">${item.relatedNames2}</div>
                        </div>
                        <div class="result-field">
                            <div class="field-label">Common Test Rank</div>
                            <div class="field-value">${testRankDisplay}</div>
                        </div>
                        <div class="result-field">
                            <div class="field-label">Common Order Rank</div>
                            <div class="field-value">${orderRankDisplay}</div>
                        </div>
                        <div class="result-field">
                            <div class="field-label">Long Common Name</div>
                            <div class="field-value">${item.longCommonName}</div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // Combine close button and results
            resultsDiv.innerHTML = closeButtonHtml + resultsHtml;
        }
        
        // Function to close AI suggestions
        function closeSuggestions() {
            const suggestionList = document.getElementById('suggestionList');
            suggestionList.style.display = 'none';
            suggestionList.innerHTML = '';
            
            console.log('AI suggestions closed');
        }
        
        // Function to close search results
        function closeResults() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            // Also disable the analyze button since there are no results to analyze
            document.getElementById('analyzeBtn').disabled = true;
            
            // Clear current search results
            currentSearchResults = [];
            
            console.log('Search results closed');
        }
        
        // Auto-update functionality
        let searchTimeout;
        const AUTO_SEARCH_DELAY = 1500; // 1.5 seconds delay after user stops typing

        function setupAutoUpdate() {
            // Show auto-update indicator
            const indicator = document.getElementById('autoUpdateIndicator');
            if (indicator) {
                indicator.style.display = 'inline';
            }

            // Add input event listeners to all search fields
            const searchFields = ['field1', 'field2', 'componentField', 'systemField'];

            searchFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        // Clear previous timeout
                        clearTimeout(searchTimeout);

                        // Check if field1 has at least 2 characters
                        const field1Value = document.getElementById('field1').value.trim();
                        if (field1Value.length >= 2) {
                            // Show loading indicator
                            const resultsDiv = document.getElementById('results');
                            if (resultsDiv && !resultsDiv.querySelector('.searching')) {
                                resultsDiv.innerHTML = '<div class="searching" style="color: #666; font-style: italic;">Ê∫ñÂÇôÊêúÂ∞ã...</div>';
                            }

                            // Set new timeout for auto-search
                            searchTimeout = setTimeout(() => {
                                console.log('Auto-searching after input change');
                                search();
                            }, AUTO_SEARCH_DELAY);
                        } else if (field1Value.length === 0) {
                            // Clear results if field1 is empty
                            const resultsDiv = document.getElementById('results');
                            if (resultsDiv) {
                                resultsDiv.innerHTML = '';
                            }
                        }
                    });
                }
            });

            // Also add listeners to checkboxes
            const checkboxes = ['orderRankFilter', 'testRankFilter'];
            checkboxes.forEach(checkboxId => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        // Only auto-search if there's already search text
                        const field1Value = document.getElementById('field1').value.trim();
                        if (field1Value.length >= 2) {
                            clearTimeout(searchTimeout);
                            searchTimeout = setTimeout(() => {
                                console.log('Auto-searching after checkbox change');
                                search();
                            }, 500); // Shorter delay for checkboxes
                        }
                    });
                }
            });
        }

        // Final initialization - ensure this runs after everything is loaded
        window.addEventListener('load', function() {
            console.log('Window load event fired');
            populateFormFromUrl();
            setupAutoUpdate(); // Initialize auto-update functionality
        });

        // Also try one more time after a short delay
        setTimeout(function() {
            console.log('Timeout initialization');
            populateFormFromUrl();
            setupAutoUpdate(); // Ensure auto-update is initialized

            // Final check of form values
            setTimeout(function() {
                console.log('=== FINAL FORM VALUES CHECK ===');
                console.log('field1 value:', document.getElementById('field1')?.value);
                console.log('field2 value:', document.getElementById('field2')?.value);
                console.log('orderRankFilter checked:', document.getElementById('orderRankFilter')?.checked);
                console.log('testRankFilter checked:', document.getElementById('testRankFilter')?.checked);
                console.log('labDataContext:', labDataContext);
                console.log('Auto-update enabled:', typeof setupAutoUpdate === 'function');
            }, 50);
        }, 100);
        
        // Debug function to test URL parameters
        function debugUrlParams() {
            console.log('=== DEBUG URL PARAMETERS ===');
            console.log('Current URL:', window.location.href);
            console.log('Search params:', window.location.search);
            
            const searchTerms = getUrlParameter('searchTerms');
            const mustHaveTerms = getUrlParameter('mustHaveTerms');
            const rankFilter1 = getUrlParameter('rankFilter1');
            const rankFilter2 = getUrlParameter('rankFilter2');
            
            console.log('Parsed parameters:', {
                searchTerms,
                mustHaveTerms,
                rankFilter1,
                rankFilter2
            });
            
            if (searchTerms) {
                console.log('Decoded searchTerms:', decodeURIComponent(searchTerms));
            }
            
            console.log('Field1 value:', document.getElementById('field1').value);
            console.log('Field2 value:', document.getElementById('field2').value);
            console.log('OrderRankFilter checked:', document.getElementById('orderRankFilter').checked);
            console.log('TestRankFilter checked:', document.getElementById('testRankFilter').checked);
            
            // Try to populate again
            populateFormFromUrl();
        }
    </script>
    
    <!-- ÂºïÂÖ•Ëá™ÂãïÈÅ∏‰∏≠ËÖ≥Êú¨ -->
    <script src="/auto-select-loinc.js"></script>
</body>
</html>